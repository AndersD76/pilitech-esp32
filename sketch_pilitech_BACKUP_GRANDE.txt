/************************************************************
 * PILI TECH - Sistema v9.0 PRODU√á√ÉO FINAL
 * N√∫mero de S√©rie: 00002025
 * Interface profissional otimizada para Tablet 9"
 * C√≥digo completo e testado - ESP32-S3
 *
 * NOVIDADES v9.0:
 * - WiFi Station mode (conectar √† internet via celular)
 * - Salvamento autom√°tico na SPIFFS
 * - HTML embutido leg√≠vel (n√£o minificado)
 * - 5 abas completas: Dashboard, Sistema, Logs, FAQ, Contato
 * - Sistema de pagina√ß√£o em abas
 * - Configura√ß√£o de WiFi via interface
 ************************************************************/

#include <WiFi.h>
#include <WebServer.h>
#include <WebSocketsServer.h>
#include <ArduinoJson.h>
#include <SPIFFS.h>
#include <Preferences.h>
#include <HTTPClient.h>

// ====== CONFIGURA√á√ïES DO SISTEMA ======
const char* AP_SSID = "PILI-TECH";
const char* AP_PASSWORD = "00002025";
const char* SERIAL_NUMBER = "00002025";
const char* SYSTEM_VERSION = "1.0";

// Configura√ß√µes de WiFi Station
String sta_ssid = "";
String sta_password = "";
bool wifiStationEnabled = false;
bool isConnectedToInternet = false;
unsigned long lastWiFiCheck = 0;

// Configura√ß√µes de Cloud Sync (NeonDB via Railway)
String apiEndpoint = "https://pilitech-api-production.up.railway.app/api";
String apiKey = "pilitech2025secret";
bool cloudSyncEnabled = true;
bool lastInternetState = false;
String lastSyncStatus = "Aguardando...";
unsigned long lastCloudSync = 0;

// Limites de mem√≥ria
#define MIN_FREE_HEAP 50000
#define CRITICAL_HEAP 30000

// Controle de primeira inicializa√ß√£o
bool isFirstBoot = false;
bool deviceRegistered = false;

// Servidores
WebServer server(80);
WebSocketsServer webSocket(81);
Preferences preferences;

// ====== DEFINI√á√ÉO DE PINOS ESP32-S3 WAVESHARE ======
#define SENSOR_0_GRAUS      4
#define SENSOR_40_GRAUS     5
#define SENSOR_TRAVA_RODA   6
#define SENSOR_MOEGA_CHEIA  7
#define SENSOR_FOSSO_CHEIO  8
#define SUBINDO_PLATAFORMA  9
#define DESCENDO_PLATAFORMA 10
#define TENSAO_PLATAFORMA   11
#define LED_STATUS          38
#define BUZZER_PIN          46

// ====== ESTRUTURAS DE DADOS ======
struct SensorState {
  bool sensor_0_graus;
  bool sensor_40_graus;
  bool sensor_trava_roda;
  bool sensor_moega_cheia;
  bool sensor_fosso_cheio;
  bool subindo_plataforma;
  bool descendo_plataforma;
  bool sistema_ligado;
  unsigned long lastUpdate;
};

struct SystemStats {
  uint32_t ciclosHoje;
  uint32_t ciclosTotal;
  uint32_t horasOperacao;
  uint32_t minutosOperacao;
  uint32_t segundosOperacao;
  unsigned long tempoInicio;
  uint32_t lastDayTimestamp;
};

struct SystemConfig {
  bool autoReset;
  uint8_t horaReset;
  bool alarmeAtivo;
  uint32_t limitesCiclos;
};

// Vari√°veis globais
SensorState sensors;
SystemStats stats;
SystemConfig config;
unsigned long previousMillis = 0;
unsigned long uptimeSeconds = 0;
unsigned long lastSaveTime = 0;
bool ultimoSensor0 = false;
bool ultimoSensor40 = false;
unsigned long tempoCicloInicio = 0;
bool cicloEmAndamento = false;

// ====== HTML EMBUTIDO (VERS√ÉO LEG√çVEL) ======
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1024">
<title>PILI TECH v1.0</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --primary: #dc2626;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --bg: #f1f5f9;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #0f172a;
  --text-light: #64748b;
}
html, body {
  width: 1024px;
  height: 600px;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
}
#app { display: flex; flex-direction: column; height: 600px; }

/* Header */
.header {
  height: 50px;
  background: white;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.logo { font-size: 18px; font-weight: 700; color: var(--primary); }
.status {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 12px;
  font-weight: 600;
}
.status-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--bg);
  border-radius: 20px;
}
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ef4444;
}
.status.connected .status-dot {
  background: var(--success);
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Tabs */
.tabs {
  height: 40px;
  background: white;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 4px;
  padding: 4px 8px;
}
.tab {
  flex: 1;
  border: none;
  background: transparent;
  padding: 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-light);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.tab.active { background: var(--primary); color: white; }

/* Content */
.content { height: 510px; overflow: hidden; }
.panel { display: none; height: 510px; padding: 12px; }
.panel.active { display: block; }
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.card-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

/* Dashboard */
.dashboard.active {
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: 1fr auto;
  gap: 12px;
}
/* Sistema */
.system.active {
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: auto auto;
  gap: 12px;
}
.page-content { display: none; }
.page-content.active {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
  height: 452px;
}
.pagination {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 8px;
}
.page-btn {
  padding: 8px 16px;
  border: none;
  background: var(--bg);
  color: var(--text);
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.page-btn.active { background: var(--primary); color: white; }

/* Sensors */
.sensors { grid-column: 1; grid-row: 1; overflow: hidden; display: flex; flex-direction: column; }
.sensors-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(2, 1fr);
  gap: 8px;
  flex: 1;
}
.sensor {
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.sensor.on { background: var(--success); border-color: var(--success); color: white; }
.sensor.alert {
  background: var(--warning);
  border-color: var(--warning);
  color: white;
  animation: alertPulse 1s infinite;
}
@keyframes alertPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
.sensor-name {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  margin-bottom: 6px;
  opacity: 0.8;
}
.sensor-val { font-size: 13px; font-weight: 600; }

/* Stats */
.stats { grid-column: 2; grid-row: 1; overflow: hidden; }
.stats-grid {
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: repeat(4, 1fr);
  gap: 8px;
  height: 100%;
}
.stat {
  background: var(--bg);
  border-radius: 6px;
  padding: 12px;
  text-align: center;
}
.stat-num {
  font-size: 36px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1;
  margin-bottom: 8px;
}
.stat-label { font-size: 13px; color: var(--text-light); font-weight: 600; }

/* System */
.system { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; gap: 12px; }
.info-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}
.info-row:last-child { border-bottom: none; }
.info-label { color: var(--text-light); font-weight: 500; }
.info-value { font-weight: 700; color: var(--text); }

/* WiFi */
.wifi-input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
}
.btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.btn {
  padding: 14px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--primary);
  color: white;
}
.btn:active { transform: scale(0.98); }
.btn.secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }

/* Logs */
.logs { grid-template-columns: 1fr; grid-template-rows: 1fr; }
.log-container { height: 460px; overflow-y: auto; }
.log {
  padding: 10px;
  margin-bottom: 6px;
  border-radius: 6px;
  border-left: 3px solid;
  font-size: 11px;
  background: var(--bg);
}
.log.ok { border-color: var(--success); }
.log.warn { border-color: var(--warning); }
.log.error { border-color: var(--danger); }
.log-time { font-weight: 600; opacity: 0.7; margin-bottom: 4px; }

/* FAQ */
.faq-section { margin-bottom: 24px; }
.faq-header {
  background: var(--primary);
  color: white;
  padding: 10px 16px;
  border-radius: 6px;
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 12px;
}
.faq-item { margin-bottom: 16px; }
.faq-question {
  font-weight: 700;
  color: var(--text);
  margin-bottom: 6px;
  font-size: 13px;
}
.faq-answer {
  color: var(--text-light);
  font-size: 12px;
  line-height: 1.6;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-light); }
</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div class="header">
    <div class="logo">PILI TECH v1.0</div>
    <div class="status">
      <div class="status-badge" id="status">
        <div class="status-dot"></div>
        <span>Conectando...</span>
      </div>
      <div class="status-badge" id="cloudStatus" style="display:none;">
        <span>‚òÅÔ∏è</span>
        <span id="cloudStatusText">Offline</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab(0)">Dashboard</button>
    <button class="tab" onclick="switchTab(1)">Sistema</button>
    <button class="tab" onclick="switchTab(2)">Logs</button>
    <button class="tab" onclick="switchTab(3)">FAQ</button>
    <button class="tab" onclick="switchTab(4)">Contato</button>
  </div>

  <!-- Content -->
  <div class="content">

    <!-- Dashboard -->
    <div class="panel dashboard active">
      <div class="page-content active">
        <div class="card sensors">
          <div class="card-title">Sensores</div>
          <div class="sensors-grid" id="sensorsGrid"></div>
        </div>
        <div class="card stats">
          <div class="card-title">Produ√ß√£o</div>
          <div class="stats-grid" id="statsGrid"></div>
        </div>
      </div>

      <div class="page-content">
        <div class="card" style="height:100%;overflow:hidden;">
          <div class="card-title">Controles e Monitoramento</div>
          <div style="display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;height:calc(100% - 45px);">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
              <div style="background:var(--bg);border-radius:6px;padding:16px;text-align:center;">
                <div style="font-size:32px;font-weight:700;color:var(--primary);" id="displayCiclosTotal">0</div>
                <div style="font-size:12px;color:var(--text-light);margin-top:4px;">Ciclos Totais</div>
              </div>
              <div style="background:var(--bg);border-radius:6px;padding:16px;text-align:center;">
                <div style="font-size:32px;font-weight:700;color:var(--primary);" id="displayHorimetro">0h</div>
                <div style="font-size:12px;color:var(--text-light);margin-top:4px;">Hor√≠metro</div>
              </div>
              <div style="background:var(--bg);border-radius:6px;padding:16px;text-align:center;">
                <div style="font-size:32px;font-weight:700;color:var(--primary);" id="displayCiclosDia">0</div>
                <div style="font-size:12px;color:var(--text-light);margin-top:4px;">Ciclos Hoje</div>
              </div>
            </div>

            <div style="background:var(--bg);border-radius:6px;padding:16px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:13px;font-weight:600;color:var(--text-light);">
                <span>Pr√≥xima Manuten√ß√£o</span>
                <span><span id="horasAteManutencao">2000</span>h restantes</span>
              </div>
              <div style="width:100%;height:16px;background:#e2e8f0;border-radius:8px;overflow:hidden;">
                <div id="maintenanceProgressBar" style="height:100%;background:linear-gradient(90deg,#10b981,#f59e0b);transition:width .5s;width:0%;"></div>
              </div>
              <div style="font-size:11px;color:var(--text-light);margin-top:8px;text-align:center;">
                Meta: manuten√ß√£o a cada 2000 horas
              </div>
            </div>

            <div></div>

            <div class="btn-grid">
              <button class="btn" onclick="saveData()">üíæ Salvar Dados</button>
              <button class="btn secondary" onclick="exportData()">üì• Exportar JSON</button>
            </div>
          </div>
        </div>
      </div>

      <div class="pagination">
        <button class="page-btn active" onclick="switchDashPage(0)">Sensores</button>
        <button class="page-btn" onclick="switchDashPage(1)">Controles</button>
      </div>
    </div>

    <!-- Sistema -->
    <div class="panel system">
      <div class="card">
        <div class="card-title">Informa√ß√µes do Sistema</div>
        <div id="sysInfo"></div>
      </div>
      <div class="card">
        <div class="card-title">Configura√ß√£o WiFi</div>
        <input type="text" class="wifi-input" id="wifiSSID" placeholder="Nome da Rede (SSID)">
        <input type="password" class="wifi-input" id="wifiPass" placeholder="Senha">
        <div class="btn-grid">
          <button class="btn" onclick="saveWiFi()">Conectar</button>
          <button class="btn secondary" onclick="disconnectWiFi()">Desconectar</button>
        </div>
        <div id="wifiStatus" style="margin-top:12px;font-size:11px;color:var(--text-light);"></div>
      </div>
    </div>

    <!-- Logs -->
    <div class="panel logs">
      <div class="card" style="height:100%;">
        <div class="card-title">Registro de Eventos</div>
        <div class="log-container" id="logsArea"></div>
      </div>
    </div>

    <!-- FAQ -->
    <div class="panel">
      <div class="card" style="height:100%;overflow-y:auto;">
        <div class="card-title">‚ùì Perguntas Frequentes (FAQ)</div>
        <div style="padding:0 8px;">
          <div class="faq-section">
            <div class="faq-header">üì± PILI TECH v9.0 (Sistema de Monitoramento)</div>

            <div class="faq-item">
              <div class="faq-question">1. O que √© o PILI TECH?</div>
              <div class="faq-answer">
                √â um sistema eletr√¥nico de monitoramento IoT que controla automaticamente o tombador de gr√£os,
                registra ciclos de opera√ß√£o, hor√≠metro, alertas e sincroniza dados com a nuvem.
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">2. Como acessar a interface?</div>
              <div class="faq-answer">
                Conecte o tablet √† rede WiFi "PILI-TECH" (senha: 00002025) e acesse http://192.168.4.1
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">3. O que significam os sensores?</div>
              <div class="faq-answer">
                ‚Ä¢ <strong>0 Graus:</strong> Plataforma horizontal<br>
                ‚Ä¢ <strong>40 Graus:</strong> Plataforma inclinada (descarga)<br>
                ‚Ä¢ <strong>Trava Roda:</strong> Sistema de travamento acionado<br>
                ‚Ä¢ <strong>Subindo/Descendo:</strong> Movimento da plataforma<br>
                ‚Ä¢ <strong>Moega/Fosso:</strong> Indicadores de capacidade
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">4. Os dados ficam salvos se faltar energia?</div>
              <div class="faq-answer">
                Sim! Todos os dados s√£o salvos automaticamente na mem√≥ria interna (SPIFFS) a cada 5 minutos
                e tamb√©m no tablet via localStorage. Nada √© perdido.
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">5. Como conectar √† internet?</div>
              <div class="faq-answer">
                V√° em Sistema ‚Üí Digite SSID e senha da rede ‚Üí Clique Conectar.
                O ESP32 mant√©m o AP PILI-TECH e conecta √† internet simultaneamente.
              </div>
            </div>
          </div>

          <div class="faq-section">
            <div class="faq-header">üöú TOMBADOR PILI</div>

            <div class="faq-item">
              <div class="faq-question">1. Qual a capacidade suportada?</div>
              <div class="faq-answer">
                Os tombadores PILI suportam cargas de at√© 60 toneladas, dependendo do modelo.
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">2. Tempo de descarga?</div>
              <div class="faq-answer">
                O tempo m√©dio √© de 3 a 5 minutos, dependendo do tipo de gr√£o e umidade.
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">3. Frequ√™ncia de manuten√ß√£o?</div>
              <div class="faq-answer">
                Recomenda-se manuten√ß√£o preventiva a cada 2000 horas de opera√ß√£o.
                Inclui: √≥leo hidr√°ulico, mangueiras, veda√ß√µes e sensores.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contato -->
    <div class="panel">
      <div class="card" style="height:100%;overflow-y:auto;">
        <div class="card-title">üìû Contato PILI</div>
        <div style="padding:16px;">
          <div style="text-align:center;margin-bottom:24px;padding:20px;background:linear-gradient(135deg,var(--primary),#ef4444);border-radius:8px;color:white;">
            <div style="font-size:28px;font-weight:700;margin-bottom:8px;">PILI</div>
            <div style="font-size:13px;opacity:0.95;">Os Melhores Tombadores de Gr√£os do Brasil</div>
            <div style="font-size:11px;margin-top:6px;opacity:0.85;">Desde 1979 ‚Ä¢ Qualidade e Inova√ß√£o</div>
          </div>

          <div style="display:grid;gap:16px;">
            <div style="background:var(--bg);padding:16px;border-radius:8px;border-left:4px solid var(--primary);">
              <div style="font-size:24px;margin-bottom:8px;">üìû</div>
              <div style="font-weight:700;margin-bottom:6px;font-size:14px;">Telefones</div>
              <div style="color:var(--text-light);font-size:13px;">
                <strong>Fixo:</strong> +54-3522-2828<br>
                <strong>WhatsApp:</strong> 054 9 9141 2971
              </div>
            </div>

            <div style="background:var(--bg);padding:16px;border-radius:8px;border-left:4px solid var(--primary);">
              <div style="font-size:24px;margin-bottom:8px;">‚úâÔ∏è</div>
              <div style="font-weight:700;margin-bottom:6px;font-size:14px;">E-mail</div>
              <div style="color:var(--text-light);font-size:13px;">atendimento@pili.ind.br</div>
            </div>

            <div style="background:var(--bg);padding:16px;border-radius:8px;border-left:4px solid var(--primary);">
              <div style="font-size:24px;margin-bottom:8px;">üìç</div>
              <div style="font-weight:700;margin-bottom:6px;font-size:14px;">Endere√ßo</div>
              <div style="color:var(--text-light);font-size:13px;">
                Bairro Petit Vilage<br>Erechim, RS 242<br>Brasil
              </div>
            </div>

            <div style="background:var(--bg);padding:16px;border-radius:8px;border-left:4px solid var(--primary);">
              <div style="font-size:24px;margin-bottom:8px;">üåê</div>
              <div style="font-weight:700;margin-bottom:6px;font-size:14px;">Website</div>
              <div style="color:var(--text-light);font-size:13px;">
                <a href="https://www.pili.ind.br" target="_blank" style="color:var(--primary);text-decoration:none;font-weight:600;">www.pili.ind.br</a>
              </div>
            </div>
          </div>

          <div style="margin-top:24px;text-align:center;padding:16px;background:var(--bg);border-radius:8px;">
            <div style="font-size:11px;color:var(--text-light);margin-bottom:8px;">Clientes que Confiam na PILI:</div>
            <div style="font-size:13px;font-weight:700;color:var(--text);">Cargill ‚Ä¢ JBS ‚Ä¢ BRF ‚Ä¢ COFCO</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JavaScript -->
<script>
console.log('=== PILI TECH JavaScript iniciado ===');
var ws = null;
var data = {};
var logs = [];

function connectWS() {
  console.log('Tentando conectar WebSocket...');
  ws = new WebSocket('ws://' + window.location.hostname + ':81');

  ws.onopen = function() {
    console.log('WebSocket conectado!');
    document.getElementById('status').classList.add('connected');
    document.getElementById('status').querySelector('span').textContent = 'Conectado';
    addLog('Sistema conectado', 'ok');
    restoreData();
  };

  ws.onerror = function(err) {
    console.error('Erro WebSocket:', err);
    document.getElementById('status').querySelector('span').textContent = 'Erro de conex√£o';
  };

  ws.onclose = function() {
    console.log('WebSocket desconectado');
    document.getElementById('status').classList.remove('connected');
    document.getElementById('status').querySelector('span').textContent = 'Reconectando...';
    setTimeout(connectWS, 2000);
  };

  ws.onmessage = function(e) {
    try {
      data = JSON.parse(e.data);
      saveDataLocal();
      updateUI();
    } catch (err) {
      console.error('Erro ao processar mensagem:', err);
    }
  };
}

function saveDataLocal() {
  localStorage.setItem('pili_ciclosHoje', data.ciclosHoje || 0);
  localStorage.setItem('pili_ciclosTotal', data.ciclosTotal || 0);
  localStorage.setItem('pili_horasOperacao', data.horasOperacao || 0);
  localStorage.setItem('pili_minutosOperacao', data.minutosOperacao || 0);
}

function restoreData() {
  var ct = localStorage.getItem('pili_ciclosTotal');
  var ho = localStorage.getItem('pili_horasOperacao');
  if (ct) {
    console.log('Restaurando dados salvos...');
    addLog('Dados restaurados: ' + ct + ' ciclos, ' + ho + 'h', 'ok');
    send('RESTORE_DATA', {
      ciclosHoje: parseInt(localStorage.getItem('pili_ciclosHoje')) || 0,
      ciclosTotal: parseInt(ct) || 0,
      horasOperacao: parseInt(ho) || 0,
      minutosOperacao: parseInt(localStorage.getItem('pili_minutosOperacao')) || 0
    });
  }
}

function updateUI() {
  updateSensors();
  updateStats();
  updateProgress();
  updateSysInfo();
  updateCloudStatus();
}

function updateCloudStatus() {
  var cloudBadge = document.getElementById('cloudStatus');
  var cloudText = document.getElementById('cloudStatusText');
  if (data.wifiConnected && data.cloudSyncEnabled) {
    cloudBadge.style.display = 'flex';
    cloudText.textContent = data.cloudSyncStatus || 'Aguardando...';
  } else {
    cloudBadge.style.display = 'none';
  }
}

function updateSensors() {
  var list = [
    {name:'SISTEMA', val:data.sistema_ligado?'ON':'OFF', on:data.sistema_ligado},
    {name:'0¬∞', val:data.sensor_0_graus?'ATIVO':'INATIVO', on:data.sensor_0_graus},
    {name:'40¬∞', val:data.sensor_40_graus?'ATIVO':'INATIVO', on:data.sensor_40_graus},
    {name:'TRAVA', val:data.trava_roda?'ATIVO':'INATIVO', on:data.trava_roda},
    {name:'SUBINDO', val:data.subindo?'SIM':'N√ÉO', on:data.subindo},
    {name:'DESCENDO', val:data.descendo?'SIM':'N√ÉO', on:data.descendo},
    {name:'MOEGA', val:data.moega_cheia?'CHEIA':'OK', on:data.moega_cheia, alert:data.moega_cheia},
    {name:'FOSSO', val:data.fosso_cheio?'CHEIO':'OK', on:data.fosso_cheio, alert:data.fosso_cheio}
  ];

  var html = '';
  for (var i = 0; i < list.length; i++) {
    var s = list[i];
    var cls = 'sensor';
    if (s.alert) cls += ' alert';
    else if (s.on) cls += ' on';
    html += '<div class="' + cls + '">';
    html += '<div class="sensor-name">' + s.name + '</div>';
    html += '<div class="sensor-val">' + s.val + '</div>';
    html += '</div>';
  }
  document.getElementById('sensorsGrid').innerHTML = html;
}

function updateStats() {
  var list = [
    {label:'Hoje', num:data.ciclosHoje||0},
    {label:'Total', num:data.ciclosTotal||0},
    {label:'Horas', num:(data.horasOperacao||0)+'h'},
    {label:'Mem√≥ria', num:fmtBytes(data.freeHeap||0)}
  ];

  var html = '';
  for (var i = 0; i < list.length; i++) {
    html += '<div class="stat">';
    html += '<div class="stat-num">' + list[i].num + '</div>';
    html += '<div class="stat-label">' + list[i].label + '</div>';
    html += '</div>';
  }
  document.getElementById('statsGrid').innerHTML = html;
}

function updateProgress() {
  document.getElementById('displayCiclosTotal').textContent = data.ciclosTotal || 0;
  document.getElementById('displayCiclosDia').textContent = data.ciclosHoje || 0;
  var totalHoras = (data.horasOperacao || 0);
  document.getElementById('displayHorimetro').textContent = totalHoras + 'h';

  var horasDesdeManut = totalHoras;
  var ultimaManut = localStorage.getItem('lastMaintHours');
  if (ultimaManut) horasDesdeManut = totalHoras - parseInt(ultimaManut);

  var percent = Math.min((horasDesdeManut / 2000) * 100, 100);
  document.getElementById('maintenanceProgressBar').style.width = percent + '%';

  var horasRestantes = Math.max(2000 - horasDesdeManut, 0);
  document.getElementById('horasAteManutencao').textContent = horasRestantes;
}

function updateSysInfo() {
  var info = [
    {l:'Vers√£o', v:data.version||'1.0'},
    {l:'S√©rie', v:data.serial||'00002025'},
    {l:'Uptime', v:fmtUptime(data.uptime||0)},
    {l:'Mem√≥ria', v:fmtBytes(data.freeHeap||0)},
    {l:'RSSI', v:(data.rssi||0)+' dBm'},
    {l:'Internet', v:data.wifiConnected?'Conectado':'Desconectado'},
    {l:'Nuvem', v:data.cloudSyncStatus||'Aguardando...'}
  ];

  var html = '';
  for (var i = 0; i < info.length; i++) {
    html += '<div class="info-row">';
    html += '<span class="info-label">' + info[i].l + '</span>';
    html += '<span class="info-value">' + info[i].v + '</span>';
    html += '</div>';
  }
  document.getElementById('sysInfo').innerHTML = html;
}

function addLog(msg, type) {
  var t = new Date().toLocaleTimeString('pt-BR');
  logs.unshift({t:t, msg:msg, type:type});
  if (logs.length > 50) logs.pop();
  renderLogs();
}

function renderLogs() {
  var html = '';
  for (var i = 0; i < logs.length; i++) {
    var l = logs[i];
    html += '<div class="log ' + l.type + '">';
    html += '<div class="log-time">' + l.t + '</div>';
    html += '<div>' + l.msg + '</div>';
    html += '</div>';
  }
  if (!html) html = '<p style="text-align:center;color:var(--text-light);padding:20px;">Nenhum log</p>';
  document.getElementById('logsArea').innerHTML = html;
}

function fmtUptime(s) {
  var d = Math.floor(s / 86400);
  var h = Math.floor((s % 86400) / 3600);
  var m = Math.floor((s % 3600) / 60);
  if (d > 0) return d + 'd ' + h + 'h';
  if (h > 0) return h + 'h ' + m + 'm';
  return m + 'm';
}

function fmtBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

function switchTab(n) {
  console.log('switchTab chamado, √≠ndice:', n);
  var tabs = document.querySelectorAll('.tab');
  var panels = document.querySelectorAll('.panel');
  console.log('Tabs encontradas:', tabs.length, 'Pain√©is encontrados:', panels.length);
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove('active');
    panels[i].classList.remove('active');
  }
  tabs[n].classList.add('active');
  panels[n].classList.add('active');
  console.log('Tab', n, 'ativada');
}

function switchDashPage(n) {
  var panel = document.querySelectorAll('.panel')[0];
  var pages = panel.querySelectorAll('.page-content');
  var btns = panel.querySelectorAll('.page-btn');
  for (var i = 0; i < pages.length; i++) {
    pages[i].classList.remove('active');
    btns[i].classList.remove('active');
  }
  pages[n].classList.add('active');
  btns[n].classList.add('active');
}

function send(cmd, payload) {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify(Object.assign({command:cmd}, payload||{})));
  } else {
    alert('Sistema desconectado!');
  }
}

function saveData() {
  send('SAVE_DATA');
  addLog('Dados salvos', 'ok');
}

function exportData() {
  var str = JSON.stringify(data, null, 2);
  var blob = new Blob([str], {type:'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'pilitech_' + Date.now() + '.json';
  a.click();
  addLog('Dados exportados', 'ok');
}

function saveWiFi() {
  var ssid = document.getElementById('wifiSSID').value;
  var pass = document.getElementById('wifiPass').value;
  if (!ssid) {
    alert('Informe o nome da rede!');
    return;
  }
  send('WIFI_CONFIG', {ssid:ssid, password:pass});
  addLog('Configurando WiFi: ' + ssid, 'ok');
  document.getElementById('wifiStatus').textContent = 'Conectando...';
}

function disconnectWiFi() {
  send('WIFI_DISCONNECT');
  addLog('WiFi desconectado', 'warn');
  document.getElementById('wifiStatus').textContent = 'Desconectado';
}

setInterval(function() {
  if (ws && ws.readyState === 1) send('PING');
}, 30000);

if ('wakeLock' in navigator) {
  navigator.wakeLock.request('screen').catch(function() {});
}

connectWS();
</script>
</body>
</html>
)rawliteral";

// ====== FUN√á√ïES DE CONFIGURA√á√ÉO ======
void initSPIFFS() {
  if (!SPIFFS.begin(true)) {
    Serial.println("‚ùå Erro ao montar SPIFFS");
    return;
  }
  Serial.println("‚úì SPIFFS montado");

  if (SPIFFS.exists("/stats.json")) {
    File file = SPIFFS.open("/stats.json", "r");
    if (file) {
      String content = file.readString();
      file.close();

      StaticJsonDocument<512> doc;
      DeserializationError error = deserializeJson(doc, content);

      if (!error) {
        stats.ciclosTotal = doc["ciclosTotal"] | 0;
        stats.horasOperacao = doc["horasOperacao"] | 0;
        stats.minutosOperacao = doc["minutosOperacao"] | 0;
        stats.lastDayTimestamp = doc["lastDay"] | 0;

        Serial.printf("‚úì Dados recuperados: Total=%d, Horas=%d\n",
                      stats.ciclosTotal, stats.horasOperacao);
      }
    }
  }
}

void saveDataToSPIFFS() {
  StaticJsonDocument<512> doc;

  doc["ciclosHoje"] = stats.ciclosHoje;
  doc["ciclosTotal"] = stats.ciclosTotal;
  doc["horasOperacao"] = stats.horasOperacao;
  doc["minutosOperacao"] = stats.minutosOperacao;
  doc["lastDay"] = stats.lastDayTimestamp;
  doc["timestamp"] = millis();

  File file = SPIFFS.open("/stats.json", "w");
  if (file) {
    serializeJson(doc, file);
    file.close();
    Serial.println("‚úì Dados salvos na SPIFFS");
  } else {
    Serial.println("‚ùå Erro ao salvar dados");
  }
}

void loadConfig() {
  preferences.begin("pili-tech", false);

  config.autoReset = preferences.getBool("autoReset", true);
  config.horaReset = preferences.getUChar("horaReset", 6);

  sta_ssid = preferences.getString("sta_ssid", "");
  sta_password = preferences.getString("sta_pass", "");
  wifiStationEnabled = preferences.getBool("sta_enabled", false);

  deviceRegistered = preferences.getBool("registered", false);

  if (!deviceRegistered) {
    isFirstBoot = true;
    Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
    Serial.println("‚ïë   üÜï PRIMEIRA INICIALIZA√á√ÉO DETECTADA!    ‚ïë");
    Serial.println("‚ïë   Dispositivo ser√° registrado no NeonDB   ‚ïë");
    Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  } else {
    Serial.println("‚úì Dispositivo j√° registrado");
  }

  Serial.println("‚úì Configura√ß√µes carregadas");

  if (wifiStationEnabled && sta_ssid.length() > 0) {
    Serial.printf("‚úì WiFi Station configurado: %s\n", sta_ssid.c_str());
  }
}

void saveConfig() {
  preferences.putBool("autoReset", config.autoReset);
  preferences.putUChar("horaReset", config.horaReset);
  preferences.putString("sta_ssid", sta_ssid);
  preferences.putString("sta_pass", sta_password);
  preferences.putBool("sta_enabled", wifiStationEnabled);

  Serial.println("‚úì Configura√ß√µes salvas");
}

// ====== FUN√á√ïES WiFi ======
void connectToWiFiStation() {
  if (!wifiStationEnabled || sta_ssid.length() == 0) return;

  Serial.printf("üì° Tentando conectar √† rede: %s\n", sta_ssid.c_str());

  WiFi.mode(WIFI_AP_STA);
  WiFi.begin(sta_ssid.c_str(), sta_password.c_str());

  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    isConnectedToInternet = true;
    Serial.printf("\n‚úì Conectado! IP: %s\n", WiFi.localIP().toString().c_str());
  } else {
    isConnectedToInternet = false;
    Serial.println("\n‚ùå Falha ao conectar");
    WiFi.mode(WIFI_AP);
  }
}

void disconnectFromWiFiStation() {
  WiFi.disconnect();
  WiFi.mode(WIFI_AP);
  isConnectedToInternet = false;
  wifiStationEnabled = false;
  sta_ssid = "";
  sta_password = "";
  saveConfig();
  Serial.println("‚úì WiFi Station desconectado");
}

// ====== FUN√á√ïES DE HARDWARE ======
void setupPins() {
  pinMode(LED_STATUS, OUTPUT);
  pinMode(SENSOR_0_GRAUS, INPUT_PULLUP);
  pinMode(SENSOR_40_GRAUS, INPUT_PULLUP);
  pinMode(SENSOR_TRAVA_RODA, INPUT_PULLUP);
  pinMode(SENSOR_MOEGA_CHEIA, INPUT_PULLUP);
  pinMode(SENSOR_FOSSO_CHEIO, INPUT_PULLUP);
  pinMode(SUBINDO_PLATAFORMA, INPUT_PULLUP);
  pinMode(DESCENDO_PLATAFORMA, INPUT_PULLUP);
  pinMode(TENSAO_PLATAFORMA, INPUT_PULLUP);

  digitalWrite(LED_STATUS, LOW);

  Serial.println("‚úì Pinos configurados (INPUT_PULLUP) - WaveShare");
}

void readSensors() {
  sensors.sensor_0_graus = !digitalRead(SENSOR_0_GRAUS);
  sensors.sensor_40_graus = !digitalRead(SENSOR_40_GRAUS);
  sensors.sensor_trava_roda = !digitalRead(SENSOR_TRAVA_RODA);
  sensors.sensor_moega_cheia = !digitalRead(SENSOR_MOEGA_CHEIA);
  sensors.sensor_fosso_cheio = !digitalRead(SENSOR_FOSSO_CHEIO);
  sensors.subindo_plataforma = !digitalRead(SUBINDO_PLATAFORMA);
  sensors.descendo_plataforma = !digitalRead(DESCENDO_PLATAFORMA);
  sensors.sistema_ligado = !digitalRead(TENSAO_PLATAFORMA);
  sensors.lastUpdate = millis();
}

// ====== REGISTRO INICIAL DO DISPOSITIVO ======
void registerNewDevice() {
  if (!isConnectedToInternet || !cloudSyncEnabled) {
    Serial.println("‚ö†Ô∏è  Sem internet para registrar dispositivo");
    return;
  }

  Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë   üìù REGISTRANDO DISPOSITIVO NO NEONDB    ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

  HTTPClient http;
  http.setTimeout(15000);

  String endpoint = apiEndpoint + "/devices/register";

  if (endpoint.startsWith("https://")) {
    http.begin(endpoint);
  } else {
    http.begin(endpoint);
  }

  http.addHeader("Content-Type", "application/json");
  http.addHeader("X-API-Key", apiKey);

  StaticJsonDocument<1024> doc;

  doc["serial"] = SERIAL_NUMBER;
  doc["version"] = SYSTEM_VERSION;
  doc["device_type"] = "PILI TECH Tombador";
  doc["model"] = "ESP32-S3 WaveShare";
  doc["first_boot_timestamp"] = millis();
  doc["chip_model"] = ESP.getChipModel();
  doc["chip_revision"] = ESP.getChipRevision();
  doc["cpu_freq_mhz"] = ESP.getCpuFreqMHz();
  doc["flash_size"] = ESP.getFlashChipSize();
  doc["free_heap"] = ESP.getFreeHeap();

  JsonArray sensors_array = doc.createNestedArray("available_sensors");
  sensors_array.add("sensor_0_graus");
  sensors_array.add("sensor_40_graus");
  sensors_array.add("sensor_trava_roda");
  sensors_array.add("sensor_moega_cheia");
  sensors_array.add("sensor_fosso_cheio");
  sensors_array.add("subindo_plataforma");
  sensors_array.add("descendo_plataforma");
  sensors_array.add("sistema_ligado");

  doc["status"] = "active";
  doc["registered_at"] = "NOW()";

  String payload;
  serializeJson(doc, payload);

  Serial.printf("üì§ Enviando registro (%d bytes)...\n", payload.length());
  Serial.println("üìã Dados do dispositivo:");
  Serial.printf("   ‚Ä¢ S√©rie: %s\n", SERIAL_NUMBER);
  Serial.printf("   ‚Ä¢ Vers√£o: %s\n", SYSTEM_VERSION);
  Serial.printf("   ‚Ä¢ Modelo: ESP32-S3\n");
  Serial.printf("   ‚Ä¢ Mem√≥ria: %d bytes\n", ESP.getFreeHeap());

  int httpCode = http.POST(payload);

  if (httpCode > 0) {
    Serial.printf("üì° Resposta HTTP: %d\n", httpCode);

    if (httpCode == HTTP_CODE_OK || httpCode == 201) {
      Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
      Serial.println("‚ïë   ‚úÖ DISPOSITIVO REGISTRADO COM SUCESSO!  ‚ïë");
      Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

      preferences.putBool("registered", true);
      deviceRegistered = true;
      isFirstBoot = false;

      String response = http.getString();
      Serial.println("üì• Resposta do servidor:");
      Serial.println(response);
    } else {
      Serial.printf("‚ö†Ô∏è  Erro ao registrar: HTTP %d\n", httpCode);
      String response = http.getString();
      Serial.println("Resposta: " + response);
    }
  } else {
    Serial.printf("‚ùå Erro de conex√£o: %s\n", http.errorToString(httpCode).c_str());
  }

  http.end();
}

// ====== SINCRONIZA√á√ÉO COM NUVEM ======
void syncToCloud() {
  if (!isConnectedToInternet || !cloudSyncEnabled) {
    lastSyncStatus = "Offline";
    return;
  }

  Serial.println("\n‚òÅÔ∏è Enviando dados para NeonDB...");
  lastSyncStatus = "Enviando...";

  HTTPClient http;
  http.setTimeout(10000);

  String endpoint = apiEndpoint + "/sensors";

  if (endpoint.startsWith("https://")) {
    http.begin(endpoint);
  } else {
    http.begin(endpoint);
  }

  http.addHeader("Content-Type", "application/json");
  http.addHeader("X-API-Key", apiKey);

  StaticJsonDocument<1024> doc;

  doc["serial"] = SERIAL_NUMBER;
  doc["version"] = SYSTEM_VERSION;
  doc["sensor_0_graus"] = sensors.sensor_0_graus;
  doc["sensor_40_graus"] = sensors.sensor_40_graus;
  doc["sensor_trava_roda"] = sensors.sensor_trava_roda;
  doc["sensor_moega_cheia"] = sensors.sensor_moega_cheia;
  doc["sensor_fosso_cheio"] = sensors.sensor_fosso_cheio;
  doc["subindo_plataforma"] = sensors.subindo_plataforma;
  doc["descendo_plataforma"] = sensors.descendo_plataforma;
  doc["sistema_ligado"] = sensors.sistema_ligado;
  doc["ciclos_hoje"] = stats.ciclosHoje;
  doc["ciclos_total"] = stats.ciclosTotal;
  doc["horas_operacao"] = stats.horasOperacao;
  doc["minutos_operacao"] = stats.minutosOperacao;
  doc["total_runtime_seconds"] = (stats.horasOperacao * 3600) + (stats.minutosOperacao * 60);
  doc["timestamp"] = millis();

  String payload;
  serializeJson(doc, payload);

  Serial.printf("üì§ Enviando %d bytes...\n", payload.length());

  int httpCode = http.POST(payload);

  if (httpCode > 0) {
    Serial.printf("üì° Resposta HTTP: %d\n", httpCode);

    if (httpCode == HTTP_CODE_OK || httpCode == 201) {
      lastSyncStatus = "‚úì Enviado";
      Serial.println("‚úì Dados enviados com sucesso para NeonDB!");
      lastCloudSync = millis();
    } else {
      lastSyncStatus = "‚ö†Ô∏è Erro " + String(httpCode);
      Serial.printf("‚ö†Ô∏è Erro ao enviar: HTTP %d\n", httpCode);
      String response = http.getString();
      Serial.println("Resposta: " + response);
    }
  } else {
    lastSyncStatus = "‚ùå Falha";
    Serial.printf("‚ùå Erro de conex√£o: %s\n", http.errorToString(httpCode).c_str());
  }

  http.end();
}

void processCycles() {
  static bool etapa1 = false;
  static bool etapa2 = false;
  static unsigned long lastCycleTime = 0;

  if (sensors.sensor_0_graus && !ultimoSensor0) {
    etapa1 = true;
    tempoCicloInicio = millis();
  }

  if (sensors.sensor_40_graus && !ultimoSensor40 && etapa1) {
    etapa2 = true;
  }

  if (sensors.sensor_0_graus && !ultimoSensor0 && etapa2) {
    if (millis() - lastCycleTime > 3000) {
      stats.ciclosHoje++;
      stats.ciclosTotal++;
      lastCycleTime = millis();

      Serial.printf("üîÑ CICLO #%d (Hoje: %d | Total: %d)\n",
                    stats.ciclosTotal, stats.ciclosHoje, stats.ciclosTotal);

      etapa1 = false;
      etapa2 = false;
    }
  }

  ultimoSensor0 = sensors.sensor_0_graus;
  ultimoSensor40 = sensors.sensor_40_graus;
}

// ====== FUN√á√ïES JSON ======
String createJsonData() {
  StaticJsonDocument<1024> doc;

  doc["sensor_0_graus"] = sensors.sensor_0_graus;
  doc["sensor_40_graus"] = sensors.sensor_40_graus;
  doc["trava_roda"] = sensors.sensor_trava_roda;
  doc["moega_cheia"] = sensors.sensor_moega_cheia;
  doc["fosso_cheio"] = sensors.sensor_fosso_cheio;
  doc["subindo"] = sensors.subindo_plataforma;
  doc["descendo"] = sensors.descendo_plataforma;
  doc["sistema_ligado"] = sensors.sistema_ligado;

  doc["ciclosHoje"] = stats.ciclosHoje;
  doc["ciclosTotal"] = stats.ciclosTotal;
  doc["horasOperacao"] = stats.horasOperacao;
  doc["minutosOperacao"] = stats.minutosOperacao;

  doc["uptime"] = uptimeSeconds;
  doc["freeHeap"] = ESP.getFreeHeap();
  doc["rssi"] = WiFi.RSSI();
  doc["clients"] = webSocket.connectedClients();
  doc["temp"] = (int)((temperatureRead() - 32) / 1.8);
  doc["serial"] = SERIAL_NUMBER;
  doc["version"] = SYSTEM_VERSION;
  doc["wifiConnected"] = isConnectedToInternet;
  doc["cloudSyncStatus"] = lastSyncStatus;
  doc["cloudSyncEnabled"] = cloudSyncEnabled;

  String jsonString;
  serializeJson(doc, jsonString);
  return jsonString;
}

// ====== WEBSOCKET HANDLERS ======
void handleWebSocketMessage(uint8_t num, uint8_t *payload, size_t length) {
  String message = "";
  for(size_t i = 0; i < length; i++) {
    message += (char)payload[i];
  }

  StaticJsonDocument<512> doc;
  DeserializationError error = deserializeJson(doc, message);

  if (!error) {
    String command = doc["command"];

    if (command == "RESTORE_DATA") {
      stats.ciclosHoje = doc["ciclosHoje"] | 0;
      stats.ciclosTotal = doc["ciclosTotal"] | 0;
      stats.horasOperacao = doc["horasOperacao"] | 0;
      stats.minutosOperacao = doc["minutosOperacao"] | 0;
      Serial.println("üì• Dados restaurados do tablet!");
      Serial.printf("   Ciclos Hoje: %d | Total: %d | Horas: %d\n",
                    stats.ciclosHoje, stats.ciclosTotal, stats.horasOperacao);
    }
    else if (command == "RESET_DAILY") {
      stats.ciclosHoje = 0;
      Serial.println("üîÑ Reset di√°rio executado");
    }
    else if (command == "RESET_TOTAL") {
      stats.ciclosHoje = 0;
      stats.ciclosTotal = 0;
      stats.horasOperacao = 0;
      stats.minutosOperacao = 0;
      Serial.println("‚ö†Ô∏è Reset total executado");
    }
    else if (command == "SAVE_DATA") {
      saveDataToSPIFFS();
      saveConfig();
      Serial.println("üíæ Dados salvos manualmente (SPIFFS + Config)");
    }
    else if (command == "WIFI_CONFIG") {
      sta_ssid = doc["ssid"].as<String>();
      sta_password = doc["password"].as<String>();
      wifiStationEnabled = true;
      saveConfig();
      Serial.printf("üì° Configurando WiFi: %s\n", sta_ssid.c_str());
      connectToWiFiStation();
    }
    else if (command == "WIFI_DISCONNECT") {
      disconnectFromWiFiStation();
    }

    String response = createJsonData();
    webSocket.sendTXT(num, response);
  }
}

void onWebSocketEvent(uint8_t num, WStype_t type, uint8_t *payload, size_t length) {
  switch(type) {
    case WStype_DISCONNECTED:
      Serial.printf("üë§ Cliente [%u] desconectado\n", num);
      break;

    case WStype_CONNECTED: {
      IPAddress ip = webSocket.remoteIP(num);
      Serial.printf("‚úì Cliente [%u] conectado: %s\n", num, ip.toString().c_str());

      String message = createJsonData();
      webSocket.sendTXT(num, message);
      break;
    }

    case WStype_TEXT:
      handleWebSocketMessage(num, payload, length);
      break;

    default:
      break;
  }
}

// ====== HTTP HANDLERS ======
void handleRoot() {
  // Tenta servir da SPIFFS primeiro
  File file = SPIFFS.open("/index.html", "r");
  if (file && file.size() > 0) {
    Serial.printf("üìÑ Enviando HTML da SPIFFS: %d bytes\n", file.size());
    server.streamFile(file, "text/html");
    file.close();
    Serial.println("‚úì HTML enviado com sucesso");
    return;
  }
  if (file) file.close();

  // Se SPIFFS falhar, usa HTML embutido com envio em chunks
  Serial.println("‚ö†Ô∏è  SPIFFS vazia, usando HTML embutido");
  size_t htmlSize = strlen_P(index_html);
  Serial.printf("üìÑ Enviando HTML embutido: %d bytes\n", htmlSize);

  server.setContentLength(htmlSize);
  server.send(200, "text/html", "");

  const size_t chunkSize = 512;  // Chunks menores para maior confiabilidade
  char buffer[chunkSize + 1];
  size_t sent = 0;

  while (sent < htmlSize) {
    size_t remaining = htmlSize - sent;
    size_t toSend = (remaining > chunkSize) ? chunkSize : remaining;

    memcpy_P(buffer, index_html + sent, toSend);
    buffer[toSend] = '\0';

    server.sendContent(buffer);
    sent += toSend;
    yield();
  }

  server.sendContent("");
  Serial.printf("‚úì HTML embutido enviado (%d bytes)\n", sent);
}

void handleNotFound() {
  server.send(404, "text/plain", "404 - P√°gina n√£o encontrada");
}

// ====== SETUP PRINCIPAL ======
void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\n\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë      PILI TECH v9.0 - INICIANDO...       ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");

  setupPins();
  digitalWrite(LED_STATUS, HIGH);

  initSPIFFS();
  loadConfig();

  Serial.println("üì° Configurando Access Point...");
  WiFi.mode(WIFI_AP);
  WiFi.softAP(AP_SSID, AP_PASSWORD);

  IPAddress IP = WiFi.softAPIP();

  Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë         ACCESS POINT ATIVO                ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.printf("‚ïë  SSID: %-33s‚ïë\n", AP_SSID);
  Serial.printf("‚ïë  Senha: %-31s‚ïë\n", AP_PASSWORD);
  Serial.printf("‚ïë  IP: %-35s‚ïë\n", IP.toString().c_str());
  Serial.printf("‚ïë  S√©rie: %-31s‚ïë\n", SERIAL_NUMBER);
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");

  if (wifiStationEnabled) {
    connectToWiFiStation();
  }

  server.on("/", handleRoot);
  server.on("/app.js", []() {
    File file = SPIFFS.open("/app.js", "r");
    if (file) {
      server.streamFile(file, "application/javascript");
      file.close();
    } else {
      server.send(404, "text/plain", "app.js n√£o encontrado");
    }
  });
  server.onNotFound(handleNotFound);
  server.begin();
  Serial.println("‚úì Servidor HTTP iniciado (porta 80)");

  webSocket.begin();
  webSocket.onEvent(onWebSocketEvent);
  Serial.println("‚úì WebSocket iniciado (porta 81)");

  digitalWrite(LED_STATUS, LOW);
  stats.tempoInicio = millis();

  Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë          üöÄ SISTEMA OPERACIONAL           ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.println("‚ïë  Acesse: http://192.168.4.1               ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
}

// ====== LOOP PRINCIPAL ======
void loop() {
  server.handleClient();
  webSocket.loop();

  unsigned long currentMillis = millis();

  // LED de status (1 segundo)
  static unsigned long lastLedBlink = 0;
  if (currentMillis - lastLedBlink >= 1000) {
    lastLedBlink = currentMillis;
    digitalWrite(LED_STATUS, !digitalRead(LED_STATUS));
    uptimeSeconds++;
  }

  // Leitura de sensores (50ms)
  static unsigned long lastSensorRead = 0;
  if (currentMillis - lastSensorRead >= 50) {
    lastSensorRead = currentMillis;
    readSensors();
    processCycles();
  }

  // Broadcast WebSocket (500ms)
  static unsigned long lastBroadcast = 0;
  if (currentMillis - lastBroadcast >= 500) {
    lastBroadcast = currentMillis;

    if (webSocket.connectedClients() > 0) {
      String jsonData = createJsonData();
      webSocket.broadcastTXT(jsonData);
    }
  }

  // Hor√≠metro (1 minuto)
  static unsigned long lastMinuteUpdate = 0;
  if (currentMillis - lastMinuteUpdate >= 60000) {
    lastMinuteUpdate = currentMillis;

    if (sensors.sistema_ligado) {
      stats.minutosOperacao++;
      stats.segundosOperacao = 0;

      if (stats.minutosOperacao >= 60) {
        stats.horasOperacao++;
        stats.minutosOperacao = 0;
      }
    }
  }

  // Auto-save (5 minutos) - SPIFFS + PREFERENCES
  static unsigned long lastSave = 0;
  if (currentMillis - lastSave >= 300000) {
    lastSave = currentMillis;
    saveDataToSPIFFS();
    saveConfig();
  }

  // Reset di√°rio autom√°tico (24 horas)
  if (config.autoReset) {
    unsigned long currentDay = currentMillis / 86400000;
    unsigned long lastDay = stats.lastDayTimestamp / 86400000;

    if (currentDay > lastDay) {
      stats.ciclosHoje = 0;
      stats.lastDayTimestamp = currentMillis;
      Serial.println("üîÑ Reset di√°rio autom√°tico");
    }
  }

  // Verificar conex√£o WiFi (1 minuto)
  if (wifiStationEnabled && currentMillis - lastWiFiCheck >= 60000) {
    lastWiFiCheck = currentMillis;

    bool currentState = (WiFi.status() == WL_CONNECTED);

    if (currentState && !lastInternetState) {
      Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
      Serial.println("‚ïë     üì° INTERNET CONECTADA!                ‚ïë");
      Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
      isConnectedToInternet = true;

      if (isFirstBoot && !deviceRegistered) {
        registerNewDevice();
        delay(2000);
      }

      if (cloudSyncEnabled && deviceRegistered) {
        syncToCloud();
      }
    } else if (!currentState && lastInternetState) {
      Serial.println("üì° Internet desconectada");
      isConnectedToInternet = false;
    } else {
      isConnectedToInternet = currentState;
    }

    lastInternetState = currentState;
  }

  // Debug e monitoramento de mem√≥ria (30 segundos)
  static unsigned long lastDebug = 0;
  if (currentMillis - lastDebug >= 30000) {
    lastDebug = currentMillis;

    uint32_t freeHeap = ESP.getFreeHeap();

    Serial.printf("\nüìä STATUS: Up:%lus | Mem:%d | Clients:%d | Ciclos:%d/%d | Sistema:%s\n",
                  uptimeSeconds,
                  freeHeap,
                  webSocket.connectedClients(),
                  stats.ciclosHoje,
                  stats.ciclosTotal,
                  sensors.sistema_ligado ? "ON" : "OFF");

    if (freeHeap < CRITICAL_HEAP) {
      Serial.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
      Serial.println("‚ïë   ‚ö†Ô∏è  MEM√ìRIA CR√çTICA! RISCO DE CRASH!   ‚ïë");
      Serial.printf("‚ïë   Livre: %d bytes (< %d bytes)         ‚ïë\n", freeHeap, CRITICAL_HEAP);
      Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
    } else if (freeHeap < MIN_FREE_HEAP) {
      Serial.printf("‚ö†Ô∏è  AVISO: Mem√≥ria baixa! Livre: %d bytes\n", freeHeap);
    } else {
      Serial.printf("‚úì Mem√≥ria OK: %d bytes livres\n", freeHeap);
    }

    if (isConnectedToInternet) {
      Serial.printf("üì° WiFi: %s (IP: %s)\n", sta_ssid.c_str(), WiFi.localIP().toString().c_str());
      Serial.printf("‚òÅÔ∏è  Nuvem: %s\n", lastSyncStatus.c_str());
    }
  }

  delay(10);
}
