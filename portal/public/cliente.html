<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PILI TECH - Portal do Cliente</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pili: { red: '#dc2626', darkred: '#991b1b', black: '#0a0a0a' }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .status-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-pili-red rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-lg text-gray-800">PILI TECH</h1>
            <p class="text-xs text-gray-500">Portal do Cliente</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <p class="text-sm font-medium text-gray-800" id="userName">Cliente</p>
            <p class="text-xs text-gray-500" id="lastUpdate">Atualizando...</p>
          </div>
          <button onclick="logout()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg" title="Sair">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Trial/Subscription Warning Banner -->
  <div id="trialBanner" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div id="trialBannerContent" class="rounded-lg p-4 flex items-center justify-between">
        <!-- Content will be filled by JS -->
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Welcome Section -->
    <div class="bg-gradient-to-r from-pili-red to-pili-darkred rounded-2xl p-8 text-white mb-8">
      <h2 class="text-2xl font-bold mb-2">Bem-vindo ao Portal PILI TECH</h2>
      <p class="text-white/80">Acompanhe em tempo real o status dos seus equipamentos</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Dispositivos Online</p>
            <p class="text-3xl font-bold text-gray-800"><span id="statOnline">0</span>/<span id="statTotal">0</span></p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Total de Ciclos</p>
            <p class="text-3xl font-bold text-gray-800" id="statCiclos">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Horimetro Total</p>
            <p class="text-3xl font-bold text-gray-800" id="statHorimetro">0h</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Devices Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-800">Meus Dispositivos</h3>
        <button onclick="refreshData()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-600">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Atualizar
        </button>
      </div>
      <div id="devicesGrid" class="space-y-4">
        <div class="text-center py-8 text-gray-500">Carregando...</div>
      </div>
    </div>

    <!-- Recent Alerts -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Alertas Recentes</h3>
      <div id="alertsList" class="space-y-3">
        <div class="text-center py-8 text-gray-500">Carregando...</div>
      </div>
    </div>

    <!-- Telemetria e Produtividade -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-800">Produtividade e Analise de Ciclos</h3>
        <select id="deviceSelector" onchange="loadTelemetry()" class="px-4 py-2 border rounded-lg text-sm">
          <option value="">Selecione um dispositivo</option>
        </select>
      </div>

      <!-- Cards de Produtividade -->
      <div id="techStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 text-center border border-green-200">
          <div class="text-3xl font-bold text-green-600" id="teleProdutividade">-</div>
          <div class="text-xs text-green-700 font-medium">PRODUTIVIDADE MEDIA</div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 text-center border border-blue-200">
          <div class="text-2xl font-bold text-blue-600" id="teleTempoCiclo">-</div>
          <div class="text-xs text-blue-700 font-medium">Tempo Medio/Ciclo</div>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 text-center border border-purple-200">
          <div class="text-2xl font-bold text-purple-600" id="teleCiclosHoje">-</div>
          <div class="text-xs text-purple-700 font-medium">Ciclos Hoje</div>
        </div>
        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 text-center border border-orange-200">
          <div class="text-2xl font-bold text-orange-600" id="teleTempoPadrao">20 min</div>
          <div class="text-xs text-orange-700 font-medium">Tempo Padrao</div>
        </div>
      </div>

      <!-- Gr치ficos -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Gr치fico de Produtividade % por Dia -->
        <div class="border rounded-lg p-4">
          <h4 class="font-semibold text-gray-700 mb-4">Produtividade % por Dia (7 dias)</h4>
          <p class="text-xs text-gray-500 mb-2">Meta: 100% = ciclo em 20 minutos</p>
          <canvas id="chartProdutividade" height="200"></canvas>
        </div>

        <!-- Gr치fico de Ciclos por Dia -->
        <div class="border rounded-lg p-4">
          <h4 class="font-semibold text-gray-700 mb-4">Ciclos por Dia (7 dias)</h4>
          <canvas id="chartCiclos" height="200"></canvas>
        </div>
      </div>

      <!-- Timeline das 9 Etapas -->
      <div class="border rounded-lg p-4 mb-6">
        <h4 class="font-semibold text-gray-700 mb-4">Timeline Media das 9 Etapas do Ciclo</h4>
        <p class="text-xs text-gray-500 mb-4">Tempo medio de cada transicao no ultimo ciclo registrado</p>
        <div class="grid grid-cols-9 gap-1 mb-2" id="timelineEtapas">
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">1.Portao</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">2.Tr.Roda</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">3.Tr.Chassi</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">4.Tr.Pinos</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">5.Sen0Inat</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">6.Pin.Solt</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">7.Cha.Solt</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">8.Rod.Solt</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[8px] text-gray-400">9.Port.Abre</div></div>
        </div>
        <div class="flex justify-between text-[10px] text-gray-400 px-1">
          <span>INICIO</span>
          <span>CICLO CONTA (5)</span>
          <span>FIM</span>
        </div>
      </div>

      <!-- Gr치fico de Tempos das Etapas -->
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold text-gray-700 mb-4">Tempo Medio por Etapa (segundos)</h4>
        <canvas id="chartEtapas" height="150"></canvas>
      </div>
    </div>

    <!-- Historico de Ciclos -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Historico de Ciclos</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data/Hora</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ciclo #</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tempo Total</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Produtividade</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Etapa + Lenta</th>
            </tr>
          </thead>
          <tbody id="cyclesTable" class="divide-y divide-gray-200">
            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Selecione um dispositivo</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex flex-col md:flex-row items-center justify-between gap-4">
        <p class="text-sm text-gray-500">PILI Equipamentos - Erechim/RS - Brasil</p>
        <div class="flex items-center gap-6 text-sm text-gray-500">
          <span>Tel: (54) 3522-2828</span>
          <span>Comercial: comercial1@pili.com.br</span>
          <span>Tecnico: engenharia@pili.ind.br</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Welcome Popup Modal -->
  <div id="welcomeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
        <!-- Header -->
        <div class="bg-gradient-to-r from-pili-red to-pili-darkred p-6 text-white text-center">
          <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-1">Bem-vindo a PILI TECH!</h2>
          <p class="text-white/80 text-sm">Sistema de Monitoramento IoT</p>
        </div>

        <!-- Content -->
        <div class="p-6">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-5">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-blue-800 text-sm">Periodo de Avaliacao</h3>
                <p class="text-xs text-blue-600">Aproveite <strong>30 dias gratis</strong> para testar!</p>
              </div>
            </div>
          </div>

          <div class="space-y-3 text-gray-600 mb-5">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm">Monitoramento em tempo real</p>
            </div>
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm">Graficos de produtividade</p>
            </div>
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm">Alertas automaticos</p>
            </div>
          </div>

          <div class="p-4 bg-gray-100 rounded-xl text-center">
            <p class="text-xs text-gray-500 mb-1">Assinatura anual por IoT</p>
            <p class="text-2xl font-bold text-gray-800">R$ 2.000,00</p>
            <p class="text-xs text-gray-400">PIX ou Cartao em ate 12x</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="px-6 pb-6">
          <button onclick="closeWelcomeModal()" class="w-full py-3 bg-pili-red text-white font-bold rounded-xl hover:bg-pili-darkred transition-colors">
            Comecar a usar!
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  </style>

  <script>
    let token = localStorage.getItem('pilitech_token');
    let user = JSON.parse(localStorage.getItem('pilitech_user') || '{}');
    let subscriptionStatus = null;

    // Check authentication
    if (!token) {
      window.location.href = '/';
    }

    // Set user name
    document.getElementById('userName').textContent = user.name || user.nome || 'Cliente';

    // Welcome modal functions
    function showWelcomeModal() {
      document.getElementById('welcomeModal').classList.remove('hidden');
    }

    function closeWelcomeModal() {
      document.getElementById('welcomeModal').classList.add('hidden');
      // Mark as seen
      localStorage.setItem('pilitech_welcome_seen', 'true');
    }

    // Check if first login (show welcome modal)
    function checkFirstLogin() {
      const welcomeSeen = localStorage.getItem('pilitech_welcome_seen');
      if (!welcomeSeen) {
        showWelcomeModal();
      }
    }

    // Show trial/subscription banner
    function showTrialBanner(status) {
      const banner = document.getElementById('trialBanner');
      const content = document.getElementById('trialBannerContent');

      if (!status || status.status === 'active') {
        banner.classList.add('hidden');
        return;
      }

      banner.classList.remove('hidden');

      if (status.status === 'trial') {
        const daysLeft = status.trialDaysRemaining || status.daysRemaining || 0;
        content.className = 'bg-yellow-100 border border-yellow-300 rounded-lg p-4 flex items-center justify-between';
        content.innerHTML = `
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
              <p class="font-bold text-yellow-800">Periodo de Avaliacao</p>
              <p class="text-sm text-yellow-700">Restam <strong>${daysLeft} dias</strong> do seu periodo gratuito</p>
            </div>
          </div>
          <a href="/checkout.html" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm font-bold">
            Assinar Agora
          </a>
        `;
      } else if (status.status === 'expired') {
        content.className = 'bg-red-100 border border-red-300 rounded-lg p-4 flex items-center justify-between';
        content.innerHTML = `
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <p class="font-bold text-red-800">Assinatura Expirada</p>
              <p class="text-sm text-red-700">A telemetria esta bloqueada. Renove para continuar monitorando.</p>
            </div>
          </div>
          <a href="/checkout.html" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-bold">
            Renovar Assinatura
          </a>
        `;
      }
    }

    // API helper
    async function api(endpoint) {
      const res = await fetch(endpoint, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (res.status === 401 || res.status === 403) {
        logout();
        return null;
      }
      return res.json();
    }

    // Logout
    function logout() {
      localStorage.removeItem('pilitech_token');
      localStorage.removeItem('pilitech_user');
      window.location.href = '/';
    }

    // Load stats
    async function loadStats() {
      const stats = await api('/api/stats');
      if (stats) {
        if (stats.blocked) {
          // Telemetria bloqueada
          document.getElementById('statTotal').textContent = '-';
          document.getElementById('statOnline').textContent = '-';
          document.getElementById('statCiclos').textContent = '-';
        } else {
          document.getElementById('statTotal').textContent = stats.totalDevices || 0;
          document.getElementById('statOnline').textContent = stats.onlineDevices || 0;
          document.getElementById('statCiclos').textContent = (stats.totalCiclos || 0).toLocaleString();
        }

        // Show subscription banner
        if (stats.subscription) {
          subscriptionStatus = stats.subscription;
          showTrialBanner(stats.subscription);
        }
      }
    }

    // Load devices
    async function loadDevices() {
      const response = await api('/api/devices');
      if (!response) {
        document.getElementById('devicesGrid').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar dispositivos</div>';
        return;
      }

      const grid = document.getElementById('devicesGrid');
      const devices = response.devices || [];

      // Update stats
      const onlineCount = devices.filter(d => d.status_conexao === 'online').length;
      document.getElementById('statOnline').textContent = onlineCount + '/' + devices.length;

      if (devices.length === 0) {
        grid.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum dispositivo encontrado para sua empresa/unidade</div>';
        return;
      }

      // Populate device selector
      const selector = document.getElementById('deviceSelector');
      selector.innerHTML = '<option value="">Selecione um dispositivo</option>' +
        devices.map(d => `<option value="${d.serial_number}">${d.name || 'Tombador'} - ${d.serial_number}</option>`).join('');

      grid.innerHTML = devices.map(d => {
        const isOnline = d.status_conexao === 'online';
        const isIdle = d.status_conexao === 'idle';
        const statusClass = isOnline ? 'bg-green-100 text-green-700' : isIdle ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';
        const statusText = isOnline ? 'Online' : isIdle ? 'Idle' : 'Offline';
        const statusDot = isOnline ? 'bg-green-500' : isIdle ? 'bg-yellow-500' : 'bg-red-500';
        const lastSeen = d.last_seen ? new Date(d.last_seen).toLocaleString('pt-BR') : 'Nunca';

        // Subscription tag
        let subTag = '';
        if (d.subscription_info && d.subscription_info.active) {
          const expiresAt = new Date(d.subscription_info.expires_at);
          subTag = `<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">Assinado ate ${expiresAt.toLocaleDateString('pt-BR')}</span>`;
        } else {
          subTag = `<span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">Sem assinatura</span>`;
        }

        return `
          <div class="border-2 ${isOnline ? 'border-green-200' : 'border-gray-200'} rounded-xl p-6 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                  </svg>
                </div>
                <div>
                  <h4 class="font-bold text-lg text-gray-800">${d.name || 'Tombador'}</h4>
                  <p class="text-sm text-gray-500">S/N: ${d.serial_number}</p>
                  <p class="text-xs text-gray-400">${d.unidade_nome ? 'Unidade: ' + d.unidade_nome : 'Sem unidade'}</p>
                  <div class="mt-1">${subTag}</div>
                </div>
              </div>
              <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full ${statusDot} ${isOnline ? 'status-pulse' : ''}"></span>
                  <span class="px-4 py-2 rounded-full text-sm font-bold ${statusClass}">${statusText}</span>
                </div>
                <p class="text-xs text-gray-400">Visto: ${lastSeen}</p>
              </div>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-4">
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-600">-</div>
                <div class="text-xs text-gray-500">Sistema</div>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-700">-</div>
                <div class="text-xs text-gray-500">0 Graus</div>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-700">-</div>
                <div class="text-xs text-gray-500">40 Graus</div>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-700">-</div>
                <div class="text-xs text-gray-500">Trava</div>
              </div>
            </div>

            <div class="flex gap-4 mt-4">
              <button onclick="viewDeviceDetails('${d.serial_number}')" class="flex-1 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred text-sm font-medium">
                Ver Detalhes
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Load telemetry data for online count
      loadStats();
    }

    async function viewDeviceDetails(serialNumber) {
      // TODO: Abrir modal com detalhes do dispositivo
      alert('Detalhes do dispositivo: ' + serialNumber);
    }

    async function loadStats() {
      try {
        const response = await api('/api/latest-readings');
        if (response && !response.blocked && response.data) {
          let totalCiclos = 0;
          let totalHoras = 0;
          response.data.forEach(d => {
            totalCiclos += (d.ciclos_total || 0);
            totalHoras += (d.horas_operacao || 0);
          });
          document.getElementById('statCiclos').textContent = totalCiclos.toLocaleString();
          document.getElementById('statHorimetro').textContent = totalHoras + 'h';
        }
      } catch (e) {
        console.log('Erro ao carregar stats:', e);
      }
    }

    // Load alerts
    async function loadAlerts() {
      const alerts = await api('/api/recent-alerts');
      if (!alerts) return;

      const list = document.getElementById('alertsList');

      if (alerts.length === 0) {
        list.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum alerta recente. Tudo funcionando normalmente!</div>';
        return;
      }

      list.innerHTML = alerts.slice(0, 10).map(a => `
        <div class="flex items-center gap-4 p-4 border rounded-lg ${a.event_type === 'ALERT' ? 'border-red-200 bg-red-50' : 'border-blue-200 bg-blue-50'}">
          <div class="w-10 h-10 rounded-full flex items-center justify-center ${a.event_type === 'ALERT' ? 'bg-red-100' : 'bg-blue-100'}">
            <svg class="w-5 h-5 ${a.event_type === 'ALERT' ? 'text-red-600' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${a.event_type === 'ALERT' ? 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' : 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}"/>
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${a.message}</p>
            <p class="text-sm text-gray-500">${new Date(a.timestamp).toLocaleString('pt-BR')}</p>
          </div>
        </div>
      `).join('');
    }

    // Check if timestamp is recent (< 10 min)
    function isRecent(timestamp) {
      if (!timestamp) return false;
      const diff = Date.now() - new Date(timestamp).getTime();
      return diff < 10 * 60 * 1000;
    }

    // Refresh all data
    async function refreshData() {
      document.getElementById('lastUpdate').textContent = 'Atualizando...';
      await Promise.all([
        loadStats(),
        loadDevices(),
        loadAlerts()
      ]);
      document.getElementById('lastUpdate').textContent = 'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');
    }

    // Initial load
    refreshData();
    checkFirstLogin();

    // Auto refresh every 30 seconds
    setInterval(refreshData, 30000);

    // ========== TELEMETRIA E PRODUTIVIDADE ==========
    let chartCiclos, chartProdutividade, chartEtapas;
    let devicesList = [];
    const TEMPO_PADRAO_CICLO = 20 * 60; // 20 minutos em segundos

    // Populate device selector
    async function populateDeviceSelector() {
      const response = await api('/api/latest-readings');
      if (!response) return;

      const readings = response.data || response || [];
      devicesList = readings;
      const selector = document.getElementById('deviceSelector');
      selector.innerHTML = '<option value="">Selecione um dispositivo</option>';

      readings.forEach(d => {
        const option = document.createElement('option');
        option.value = d.serial_number;
        option.textContent = `${d.serial_number} - ${d.name || 'PILI TECH'}`;
        selector.appendChild(option);
      });

      // Auto-select first device
      if (readings.length > 0) {
        selector.value = readings[0].serial_number;
        loadTelemetry();
      }
    }

    // Load telemetry data
    async function loadTelemetry() {
      const serialNumber = document.getElementById('deviceSelector').value;
      if (!serialNumber) return;

      // Load device stats
      const stats = await api('/api/device-stats/' + serialNumber);
      if (stats) {
        // Calcular produtividade media
        const prodMedia = stats.produtividadeMedia || 100;
        document.getElementById('teleProdutividade').textContent = prodMedia.toFixed(0) + '%';
        document.getElementById('teleProdutividade').className = 'text-3xl font-bold ' + (prodMedia >= 100 ? 'text-green-600' : prodMedia >= 80 ? 'text-yellow-600' : 'text-red-600');

        // Tempo medio por ciclo
        const tempoMedio = stats.tempoMedioCiclo || 0;
        document.getElementById('teleTempoCiclo').textContent = tempoMedio > 0 ? Math.round(tempoMedio / 60) + ' min' : '-';

        // Ciclos hoje
        document.getElementById('teleCiclosHoje').textContent = stats.ciclosHoje || 0;

        // Update charts
        if (stats.ciclosDiarios) {
          updateCiclosChart(stats.ciclosDiarios);
          updateProdutividadeChart(stats.ciclosDiarios);
        }
      }

      // Load cycle data for timeline and table
      const cycleData = await api('/api/cycle-data/' + serialNumber);
      if (cycleData && cycleData.length > 0) {
        updateTimelineEtapas(cycleData[0]);
        updateEtapasChart(cycleData);
        updateCyclesTable(cycleData);
      }
    }

    // Format time in seconds to min:sec
    function formatTime(seconds) {
      if (!seconds || seconds <= 0) return '-';
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return min + ':' + String(sec).padStart(2, '0');
    }

    // Update Ciclos Chart
    function updateCiclosChart(data) {
      const ctx = document.getElementById('chartCiclos');
      if (!ctx) return;

      if (chartCiclos) chartCiclos.destroy();

      const labels = data.map(d => {
        const date = new Date(d.dia);
        return date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' });
      });
      const values = data.map(d => parseInt(d.ciclos) || 0);

      chartCiclos = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ciclos',
            data: values,
            backgroundColor: 'rgba(220, 38, 38, 0.7)',
            borderColor: 'rgb(220, 38, 38)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Update Produtividade Chart (%)
    function updateProdutividadeChart(data) {
      const ctx = document.getElementById('chartProdutividade');
      if (!ctx) return;

      if (chartProdutividade) chartProdutividade.destroy();

      const labels = data.map(d => {
        const date = new Date(d.dia);
        return date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' });
      });
      // Produtividade = (tempo_padrao / tempo_real) * 100
      const values = data.map(d => {
        const tempoReal = parseFloat(d.tempo_medio_ciclo) || TEMPO_PADRAO_CICLO;
        return Math.min(200, (TEMPO_PADRAO_CICLO / tempoReal) * 100);
      });

      chartProdutividade = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Produtividade %',
            data: values,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                line1: { type: 'line', yMin: 100, yMax: 100, borderColor: 'rgb(220, 38, 38)', borderWidth: 2, borderDash: [5, 5] }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 150,
              ticks: { callback: v => v + '%' }
            }
          }
        }
      });
    }

    // Update Timeline das 9 Etapas
    function updateTimelineEtapas(lastCycle) {
      const timeline = document.getElementById('timelineEtapas');
      if (!timeline || !lastCycle) return;

      const etapas = [
        { nome: '1.Portao', tempo: lastCycle.etapa1_portao_aberto_fechado || 0 },
        { nome: '2.Tr.Roda', tempo: lastCycle.etapa2_portao_fechado_trava_roda || 0 },
        { nome: '3.Tr.Chassi', tempo: lastCycle.etapa3_trava_roda_trava_chassi || 0 },
        { nome: '4.Tr.Pinos', tempo: lastCycle.etapa4_trava_chassi_trava_pinos || 0 },
        { nome: '5.Sen0Inat', tempo: lastCycle.etapa5_trava_pinos_sensor0_inativo || 0 },
        { nome: '6.Pin.Solt', tempo: lastCycle.etapa6_sensor0_ativo_trava_pinos_inativo || 0 },
        { nome: '7.Cha.Solt', tempo: lastCycle.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0 },
        { nome: '8.Rod.Solt', tempo: lastCycle.etapa8_trava_chassi_inativo_trava_roda_inativo || 0 },
        { nome: '9.Port.Abre', tempo: lastCycle.etapa9_trava_roda_inativo_portao_aberto || 0 }
      ];

      const maxTempo = Math.max(...etapas.map(e => e.tempo), 1);

      timeline.innerHTML = etapas.map((e, i) => {
        const pct = (e.tempo / maxTempo) * 100;
        const bg = pct > 70 ? 'bg-red-400' : pct > 40 ? 'bg-yellow-400' : 'bg-green-400';
        return `
          <div class="${bg} rounded p-2 text-center transition-all">
            <div class="text-xs font-bold text-white">${e.tempo}s</div>
            <div class="text-[8px] text-white/80">${e.nome}</div>
          </div>
        `;
      }).join('');
    }

    // Update Etapas Chart (bar)
    function updateEtapasChart(data) {
      const ctx = document.getElementById('chartEtapas');
      if (!ctx) return;

      if (chartEtapas) chartEtapas.destroy();

      // Calcular media das etapas
      const etapasMedia = [0, 0, 0, 0, 0, 0, 0, 0, 0];
      const count = data.length;

      data.forEach(c => {
        etapasMedia[0] += c.etapa1_portao_aberto_fechado || 0;
        etapasMedia[1] += c.etapa2_portao_fechado_trava_roda || 0;
        etapasMedia[2] += c.etapa3_trava_roda_trava_chassi || 0;
        etapasMedia[3] += c.etapa4_trava_chassi_trava_pinos || 0;
        etapasMedia[4] += c.etapa5_trava_pinos_sensor0_inativo || 0;
        etapasMedia[5] += c.etapa6_sensor0_ativo_trava_pinos_inativo || 0;
        etapasMedia[6] += c.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0;
        etapasMedia[7] += c.etapa8_trava_chassi_inativo_trava_roda_inativo || 0;
        etapasMedia[8] += c.etapa9_trava_roda_inativo_portao_aberto || 0;
      });

      const values = etapasMedia.map(v => Math.round(v / count) || 0);
      const labels = ['1.Portao', '2.Tr.Roda', '3.Tr.Chassi', '4.Tr.Pinos', '5.Subindo', '6.Solt.Pin', '7.Solt.Cha', '8.Solt.Rod', '9.Port.Abre'];

      chartEtapas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Tempo (s)',
            data: values,
            backgroundColor: [
              'rgba(59, 130, 246, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(59, 130, 246, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, title: { display: true, text: 'Segundos' } } }
        }
      });
    }

    // Update Cycles Table
    function updateCyclesTable(data) {
      const tbody = document.getElementById('cyclesTable');
      if (!tbody) return;

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Nenhum ciclo registrado</td></tr>';
        return;
      }

      tbody.innerHTML = data.slice(0, 20).map(c => {
        const produtividade = c.eficiencia || ((TEMPO_PADRAO_CICLO / c.tempo_total) * 100);
        const prodClass = produtividade >= 100 ? 'text-green-600 bg-green-50' : produtividade >= 80 ? 'text-yellow-600 bg-yellow-50' : 'text-red-600 bg-red-50';

        // Encontrar etapa mais lenta
        const etapas = [
          { nome: 'Portao fecha', tempo: c.etapa1_portao_aberto_fechado || 0 },
          { nome: 'Trava roda', tempo: c.etapa2_portao_fechado_trava_roda || 0 },
          { nome: 'Trava chassi', tempo: c.etapa3_trava_roda_trava_chassi || 0 },
          { nome: 'Trava pinos', tempo: c.etapa4_trava_chassi_trava_pinos || 0 },
          { nome: 'Subindo', tempo: c.etapa5_trava_pinos_sensor0_inativo || 0 },
          { nome: 'Solta pinos', tempo: c.etapa6_sensor0_ativo_trava_pinos_inativo || 0 },
          { nome: 'Solta chassi', tempo: c.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0 },
          { nome: 'Solta roda', tempo: c.etapa8_trava_chassi_inativo_trava_roda_inativo || 0 },
          { nome: 'Portao abre', tempo: c.etapa9_trava_roda_inativo_portao_aberto || 0 }
        ];
        const maisLenta = etapas.reduce((a, b) => a.tempo > b.tempo ? a : b);

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2 text-xs text-gray-600">${c.timestamp ? new Date(c.timestamp).toLocaleString('pt-BR') : '-'}</td>
            <td class="px-4 py-2 text-center font-bold text-gray-800">#${c.ciclo_numero || '-'}</td>
            <td class="px-4 py-2 text-center font-medium">${Math.round((c.tempo_total || 0) / 60)} min</td>
            <td class="px-4 py-2 text-center">
              <span class="px-3 py-1 rounded-full text-sm font-bold ${prodClass}">${produtividade.toFixed(0)}%</span>
            </td>
            <td class="px-4 py-2 text-center text-xs text-gray-500">${maisLenta.nome} (${maisLenta.tempo}s)</td>
          </tr>
        `;
      }).join('');
    }

    // Initialize telemetry after main data loads
    setTimeout(populateDeviceSelector, 1000);
  </script>
</body>
</html>
