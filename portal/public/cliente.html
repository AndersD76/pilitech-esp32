<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PILI TECH - Portal do Cliente</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pili: { red: '#dc2626', darkred: '#991b1b', black: '#0a0a0a' }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .status-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-pili-red rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-lg text-gray-800">PILI TECH</h1>
            <p class="text-xs text-gray-500">Portal do Cliente</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <!-- Botão Assinar (visível quando não tem assinatura) -->
          <a href="/checkout.html" id="btnAssinar" class="hidden flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg font-bold text-sm hover:from-yellow-600 hover:to-orange-600 shadow-lg animate-pulse">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
            </svg>
            Assinar Agora
          </a>
          <div class="text-right">
            <p class="text-sm font-medium text-gray-800" id="userName">Cliente</p>
            <p class="text-xs text-gray-500" id="lastUpdate">Atualizando...</p>
          </div>
          <button onclick="logout()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg" title="Sair">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Trial/Subscription Warning Banner -->
  <div id="trialBanner" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div id="trialBannerContent" class="rounded-lg p-4 flex items-center justify-between">
        <!-- Content will be filled by JS -->
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Welcome Section -->
    <div class="bg-gradient-to-r from-pili-red to-pili-darkred rounded-2xl p-8 text-white mb-8">
      <h2 class="text-2xl font-bold mb-2">Bem-vindo ao Portal PILI TECH</h2>
      <p class="text-white/80">Acompanhe em tempo real o status dos seus equipamentos</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Dispositivos Online</p>
            <p class="text-3xl font-bold text-gray-800"><span id="statOnline">0</span>/<span id="statTotal">0</span></p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Total de Ciclos</p>
            <p class="text-3xl font-bold text-gray-800" id="statCiclos">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500 font-medium">Horimetro Total</p>
            <p class="text-3xl font-bold text-gray-800" id="statHorimetro">0h</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Devices Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-800">Meus Dispositivos</h3>
        <div class="flex items-center gap-3">
          <button onclick="toggleViewAll()" id="btnViewAll" class="flex items-center gap-2 px-4 py-2 bg-pili-red text-white hover:bg-pili-darkred rounded-lg text-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
            </svg>
            Ver Todos na Tela
          </button>
          <button onclick="refreshData()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Atualizar
          </button>
        </div>
      </div>
      <div id="devicesGrid" class="space-y-4">
        <div class="text-center py-8 text-gray-500">Carregando...</div>
      </div>
    </div>

    <!-- PAINEL TODOS OS IOTs (oculto por padrão) -->
    <div id="allIoTsPanel" class="hidden bg-gray-900 rounded-xl shadow-2xl p-6 mb-8 relative">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-pili-red rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white">MONITORAMENTO EM TEMPO REAL</h3>
            <p class="text-gray-400" id="allIoTsSubtitle">Todos os dispositivos da empresa</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-gray-400 text-sm" id="allIoTsLastUpdate">Atualizando...</span>
          <button onclick="toggleViewAll()" class="flex items-center gap-2 px-4 py-2 bg-white/10 text-white hover:bg-white/20 rounded-lg text-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Fechar
          </button>
        </div>
      </div>

      <!-- Grid de IoTs Compacto -->
      <div id="allIoTsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div class="text-center py-8 text-gray-500">Carregando...</div>
      </div>
    </div>

    <!-- Recent Alerts -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Alertas Recentes</h3>
      <div id="alertsList" class="space-y-3">
        <div class="text-center py-8 text-gray-500">Carregando...</div>
      </div>
    </div>

    <!-- Telemetria e Produtividade - DASHBOARD PROFISSIONAL -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800">Dashboard de Produtividade</h3>
          <p class="text-sm text-gray-500">Analise detalhada de desempenho e eficiencia</p>
        </div>
        <select id="deviceSelector" onchange="loadTelemetry()" class="px-4 py-2 border-2 border-pili-red rounded-lg text-sm font-medium focus:ring-2 focus:ring-pili-red">
          <option value="">Selecione um dispositivo</option>
        </select>
      </div>

      <!-- DASHBOARD PRINCIPAL - KPIs -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <!-- Gauge de Produtividade -->
        <div class="col-span-2 md:col-span-1 bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-5 text-center shadow-lg">
          <div class="relative w-28 h-28 mx-auto mb-2">
            <svg viewBox="0 0 36 36" class="w-28 h-28 transform -rotate-90">
              <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#374151" stroke-width="3"/>
              <path id="gaugeProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#22c55e" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"/>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-3xl font-black text-white" id="teleProdutividade">-</span>
            </div>
          </div>
          <div class="text-xs text-gray-400 font-medium uppercase tracking-wider">Produtividade</div>
        </div>

        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-xs font-medium opacity-80">TEMPO MEDIO</span>
          </div>
          <div class="text-3xl font-black" id="teleTempoCiclo">-</div>
          <div class="text-xs opacity-70">por ciclo</div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span class="text-xs font-medium opacity-80">CICLOS HOJE</span>
          </div>
          <div class="text-3xl font-black" id="teleCiclosHoje">-</div>
          <div class="text-xs opacity-70" id="teleCiclosTendencia">carregando...</div>
        </div>

        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <span class="text-xs font-medium opacity-80">CICLOS SEMANA</span>
          </div>
          <div class="text-3xl font-black" id="teleCiclosSemana">-</div>
          <div class="text-xs opacity-70">ultimos 7 dias</div>
        </div>

        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
            <span class="text-xs font-medium opacity-80">EFICIENCIA</span>
          </div>
          <div class="text-3xl font-black" id="teleEficiencia">-</div>
          <div class="text-xs opacity-70">vs meta 20min</div>
        </div>
      </div>

      <!-- GRAFICOS PROFISSIONAIS -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Grafico de Area - Produtividade -->
        <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-100 rounded-2xl p-5 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="font-bold text-gray-800">Evolucao da Produtividade</h4>
              <p class="text-xs text-gray-500">Meta: linha vermelha = 100%</p>
            </div>
            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">7 DIAS</span>
          </div>
          <canvas id="chartProdutividade" height="180"></canvas>
        </div>

        <!-- Grafico de Barras - Ciclos por Dia -->
        <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-100 rounded-2xl p-5 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="font-bold text-gray-800">Ciclos por Dia</h4>
              <p class="text-xs text-gray-500">Volume de producao diario</p>
            </div>
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">7 DIAS</span>
          </div>
          <canvas id="chartCiclos" height="180"></canvas>
        </div>
      </div>

      <!-- GRAFICOS SECUNDARIOS -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Grafico de Rosca - Distribuicao por Etapa -->
        <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-100 rounded-2xl p-5 shadow-sm">
          <h4 class="font-bold text-gray-800 mb-2">Tempo por Fase</h4>
          <p class="text-xs text-gray-500 mb-4">Distribuicao do ciclo</p>
          <canvas id="chartPizza" height="180"></canvas>
        </div>

        <!-- Grafico de Linha - Tendencia Horaria -->
        <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-100 rounded-2xl p-5 shadow-sm">
          <h4 class="font-bold text-gray-800 mb-2">Ciclos por Hora</h4>
          <p class="text-xs text-gray-500 mb-4">Producao nas ultimas 24h</p>
          <canvas id="chartHorario" height="180"></canvas>
        </div>

        <!-- Indicadores de Desempenho -->
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-5 shadow-lg text-white">
          <h4 class="font-bold mb-4">Indicadores Chave</h4>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Etapa mais rapida</span>
                <span class="font-bold text-green-400" id="etapaMaisRapida">-</span>
              </div>
              <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-green-500 rounded-full" id="barraRapida" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Etapa mais lenta</span>
                <span class="font-bold text-red-400" id="etapaMaisLenta">-</span>
              </div>
              <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-red-500 rounded-full" id="barraLenta" style="width: 100%"></div>
              </div>
            </div>
            <div class="pt-3 border-t border-gray-700">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Desvio padrao</span>
                <span class="font-bold" id="desvioPadrao">-</span>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Ciclos acima da meta</span>
                <span class="font-bold text-green-400" id="ciclosAcimaMeta">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline das 10 Etapas -->
      <div class="border rounded-lg p-4 mb-6">
        <h4 class="font-semibold text-gray-700 mb-4">Timeline Media das 10 Etapas do Ciclo</h4>
        <p class="text-xs text-gray-500 mb-4">Tempo medio de cada transicao no ultimo ciclo registrado</p>
        <div class="grid grid-cols-10 gap-1 mb-2" id="timelineEtapas">
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">1.Port.Fecha</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">2.Sen0°Inat</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">3.Tr.Roda</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">4.Tr.Chassi</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">5.Tr.Pinos</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">6.Sen0°Ativ</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">7.Solt.Roda</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">8.Solt.Chas</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">9.Solt.Pino</div></div>
          <div class="bg-gray-200 rounded p-2 text-center"><div class="text-xs font-bold text-gray-600">-</div><div class="text-[7px] text-gray-400">10.Port.Abre</div></div>
        </div>
        <div class="flex justify-between text-[10px] text-gray-400 px-1">
          <span>INICIO</span>
          <span class="text-pili-red font-bold">⬆ CICLO CONTA (6)</span>
          <span>FIM</span>
        </div>
      </div>

      <!-- Grafico de Tempos das 10 Etapas -->
      <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-100 rounded-2xl p-5 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h4 class="font-bold text-gray-800">Tempo Medio por Etapa</h4>
            <p class="text-xs text-gray-500">Analise das 10 etapas do ciclo de producao</p>
          </div>
          <span class="px-3 py-1 bg-pili-red/10 text-pili-red rounded-full text-xs font-bold">10 ETAPAS</span>
        </div>
        <canvas id="chartEtapas" height="150"></canvas>
        <div class="mt-4 flex items-center justify-center gap-6 text-xs text-gray-500">
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded bg-blue-500"></span> Portao</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded bg-green-500"></span> Travamento</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded bg-pili-red"></span> Conta Ciclo</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded bg-red-400"></span> Destravamento</div>
        </div>
      </div>
    </div>

    <!-- Historico de Ciclos -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Historico de Ciclos</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data/Hora</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ciclo #</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tempo Total</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Produtividade</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Etapa + Lenta</th>
            </tr>
          </thead>
          <tbody id="cyclesTable" class="divide-y divide-gray-200">
            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Selecione um dispositivo</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex flex-col md:flex-row items-center justify-between gap-4">
        <p class="text-sm text-gray-500">PILI Equipamentos - Erechim/RS - Brasil</p>
        <div class="flex items-center gap-6 text-sm text-gray-500">
          <span>Tel: (54) 3522-2828</span>
          <span>Comercial: comercial1@pili.com.br</span>
          <span>Tecnico: engenharia@pili.com.br</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Welcome Popup Modal -->
  <div id="welcomeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
        <!-- Header -->
        <div class="bg-gradient-to-r from-pili-red to-pili-darkred p-6 text-white text-center">
          <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-1">Bem-vindo a PILI TECH!</h2>
          <p class="text-white/80 text-sm">Sistema de Monitoramento IoT</p>
        </div>

        <!-- Content -->
        <div class="p-6">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-5">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-blue-800 text-sm">Periodo de Avaliacao</h3>
                <p class="text-xs text-blue-600">Aproveite <strong>30 dias gratis</strong> para testar!</p>
              </div>
            </div>
          </div>

          <div class="space-y-3 text-gray-600 mb-5">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm">Monitoramento em tempo real</p>
            </div>
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm">Graficos de produtividade</p>
            </div>
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm">Alertas automaticos</p>
            </div>
          </div>

          <div class="p-4 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl text-center border-2 border-yellow-300">
            <p class="text-xs text-yellow-700 mb-1 font-medium">Assinatura anual por IoT</p>
            <p class="text-3xl font-black text-gray-800">R$ 2.000<span class="text-lg">,00</span></p>
            <p class="text-xs text-yellow-600">PIX ou Cartao em ate 12x</p>
          </div>
        </div>

        <!-- Footer com 2 botões -->
        <div class="px-6 pb-6 space-y-3">
          <button onclick="goToCheckout()" class="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold rounded-xl hover:from-yellow-600 hover:to-orange-600 transition-all shadow-lg flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
            </svg>
            Assinar Agora
          </button>
          <button onclick="closeWelcomeModal()" class="w-full py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-colors">
            Continuar explorando
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  </style>

  <script>
    let token = localStorage.getItem('pilitech_token');
    let user = JSON.parse(localStorage.getItem('pilitech_user') || '{}');
    let subscriptionStatus = null;

    // Check authentication
    if (!token) {
      window.location.href = '/';
    }

    // Set user name
    document.getElementById('userName').textContent = user.name || user.nome || 'Cliente';

    // Welcome modal functions
    function showWelcomeModal() {
      document.getElementById('welcomeModal').classList.remove('hidden');
    }

    function closeWelcomeModal() {
      document.getElementById('welcomeModal').classList.add('hidden');
      // Mark as seen
      localStorage.setItem('pilitech_welcome_seen', 'true');
    }

    // Check if first login (show welcome modal)
    function checkFirstLogin() {
      const welcomeSeen = localStorage.getItem('pilitech_welcome_seen');
      // Sempre mostrar se não foi visto antes
      if (!welcomeSeen) {
        setTimeout(() => showWelcomeModal(), 500); // Delay para carregar a página primeiro
      }
    }

    // Ir para checkout
    function goToCheckout() {
      closeWelcomeModal();
      window.location.href = '/checkout.html';
    }

    // Mostrar/ocultar botão Assinar no header
    function updateSubscriptionButton(status) {
      const btn = document.getElementById('btnAssinar');
      if (!btn) return;

      // Mostrar botão se não tem assinatura ativa
      if (!status || status.status !== 'active') {
        btn.classList.remove('hidden');
        btn.classList.add('flex');
      } else {
        btn.classList.add('hidden');
        btn.classList.remove('flex');
      }
    }

    // Show trial/subscription banner
    function showTrialBanner(status) {
      const banner = document.getElementById('trialBanner');
      const content = document.getElementById('trialBannerContent');

      // Atualizar botão do header
      updateSubscriptionButton(status);

      if (!status || status.status === 'active') {
        banner.classList.add('hidden');
        return;
      }

      banner.classList.remove('hidden');

      if (status.status === 'trial') {
        const daysLeft = status.trialDaysRemaining || status.daysRemaining || 0;
        content.className = 'bg-yellow-100 border border-yellow-300 rounded-lg p-4 flex items-center justify-between';
        content.innerHTML = `
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
              <p class="font-bold text-yellow-800">Periodo de Avaliacao</p>
              <p class="text-sm text-yellow-700">Restam <strong>${daysLeft} dias</strong> do seu periodo gratuito</p>
            </div>
          </div>
          <a href="/checkout.html" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm font-bold">
            Assinar Agora
          </a>
        `;
      } else if (status.status === 'expired') {
        content.className = 'bg-red-100 border border-red-300 rounded-lg p-4 flex items-center justify-between';
        content.innerHTML = `
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <p class="font-bold text-red-800">Assinatura Expirada</p>
              <p class="text-sm text-red-700">A telemetria esta bloqueada. Renove para continuar monitorando.</p>
            </div>
          </div>
          <a href="/checkout.html" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-bold">
            Renovar Assinatura
          </a>
        `;
      } else {
        // Sem assinatura (nem trial)
        content.className = 'bg-blue-100 border border-blue-300 rounded-lg p-4 flex items-center justify-between';
        content.innerHTML = `
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <p class="font-bold text-blue-800">Assinatura Necessaria</p>
              <p class="text-sm text-blue-700">Assine para monitorar seus equipamentos em tempo real</p>
            </div>
          </div>
          <a href="/checkout.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold">
            Assinar por R$ 2.000/ano
          </a>
        `;
      }
    }

    // API helper
    async function api(endpoint) {
      const res = await fetch(endpoint, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (res.status === 401 || res.status === 403) {
        logout();
        return null;
      }
      return res.json();
    }

    // Logout
    function logout() {
      localStorage.removeItem('pilitech_token');
      localStorage.removeItem('pilitech_user');
      window.location.href = '/';
    }

    // Load stats
    async function loadStats() {
      const stats = await api('/api/stats');
      if (stats) {
        if (stats.blocked) {
          // Telemetria bloqueada
          document.getElementById('statTotal').textContent = '-';
          document.getElementById('statOnline').textContent = '-';
          document.getElementById('statCiclos').textContent = '-';
        } else {
          document.getElementById('statTotal').textContent = stats.totalDevices || 0;
          document.getElementById('statOnline').textContent = stats.onlineDevices || 0;
          document.getElementById('statCiclos').textContent = (stats.totalCiclos || 0).toLocaleString();
        }

        // Show subscription banner
        if (stats.subscription) {
          subscriptionStatus = stats.subscription;
          showTrialBanner(stats.subscription);
        }
      }
    }

    // Load devices
    async function loadDevices() {
      // Buscar dispositivos e telemetria em paralelo
      const [devResponse, teleResponse] = await Promise.all([
        api('/api/devices'),
        api('/api/latest-readings')
      ]);

      if (!devResponse) {
        document.getElementById('devicesGrid').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar dispositivos</div>';
        return;
      }

      const grid = document.getElementById('devicesGrid');
      const devices = devResponse.devices || [];
      const telemetryData = (teleResponse && !teleResponse.blocked) ? (teleResponse.data || []) : [];

      // Criar mapa de telemetria por serial_number
      const telemetryMap = {};
      telemetryData.forEach(t => { telemetryMap[t.serial_number] = t; });

      // Update stats
      const onlineCount = devices.filter(d => d.status_conexao === 'online').length;
      document.getElementById('statOnline').textContent = onlineCount + '/' + devices.length;

      if (devices.length === 0) {
        grid.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum dispositivo encontrado</div>';
        return;
      }

      // Populate device selector
      const selector = document.getElementById('deviceSelector');
      selector.innerHTML = '<option value="">Selecione um dispositivo</option>' +
        devices.map(d => `<option value="${d.serial_number}">${d.name || 'Tombador'} - ${d.serial_number}</option>`).join('');

      // Calcular totais
      let totalCiclos = 0, totalHoras = 0;
      devices.forEach(d => {
        const t = telemetryMap[d.serial_number];
        if (t) {
          totalCiclos += (t.ciclos_total || 0);
          totalHoras += (t.horas_operacao || 0);
        }
      });
      document.getElementById('statCiclos').textContent = totalCiclos.toLocaleString();
      document.getElementById('statHorimetro').textContent = totalHoras + 'h';

      grid.innerHTML = devices.map(d => {
        const t = telemetryMap[d.serial_number] || {};
        const isOnline = d.status_conexao === 'online';
        const isIdle = d.status_conexao === 'idle';
        const statusClass = isOnline ? 'bg-green-100 text-green-700' : isIdle ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';
        const statusText = isOnline ? 'Online' : isIdle ? 'Idle' : 'Offline';
        const statusDot = isOnline ? 'bg-green-500' : isIdle ? 'bg-yellow-500' : 'bg-red-500';
        const lastSeen = d.last_seen ? new Date(d.last_seen).toLocaleString('pt-BR') : 'Nunca';

        // Helper para status do sensor (verde/vermelho)
        const sensorStatus = (val, activeLabel = 'Ativo', inactiveLabel = 'Inativo') => {
          if (val === undefined || val === null) return { class: 'bg-gray-100 text-gray-400', text: '-' };
          return val
            ? { class: 'bg-green-100 text-green-700', text: activeLabel }
            : { class: 'bg-red-100 text-red-700', text: inactiveLabel };
        };

        const s0 = sensorStatus(t.sensor_0_graus);
        const s40 = sensorStatus(t.sensor_40_graus);
        const tRoda = sensorStatus(t.trava_roda);
        const tChassi = sensorStatus(t.trava_chassi);
        const tPinoE = sensorStatus(t.trava_pino_e);
        const tPinoD = sensorStatus(t.trava_pino_d);
        const moega = sensorStatus(t.moega_cheia, 'Cheia', 'OK');
        const portao = sensorStatus(t.portao_fechado, 'Fechado', 'Aberto');

        // Subscription tag
        let subTag = '';
        if (d.subscription_info && d.subscription_info.active) {
          const expiresAt = new Date(d.subscription_info.expires_at);
          subTag = `<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">Assinado ate ${expiresAt.toLocaleDateString('pt-BR')}</span>`;
        } else {
          subTag = `<span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">Sem assinatura</span>`;
        }

        return `
          <div class="border-2 ${isOnline ? 'border-green-200' : 'border-gray-200'} rounded-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-pili-red to-pili-darkred p-4 text-white">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="font-bold text-lg">${d.name || 'Tombador'}</h4>
                  <p class="text-sm text-white/80">S/N: ${d.serial_number} | ${d.unidade_nome || 'Sem unidade'}</p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full ${statusDot} ${isOnline ? 'animate-pulse' : ''}"></span>
                  <span class="px-3 py-1 rounded-full text-xs font-bold bg-white/20">${statusText}</span>
                </div>
              </div>
            </div>

            <div class="p-4">
              <!-- 8 Sensores -->
              <div class="mb-4">
                <div class="text-xs font-bold text-gray-500 mb-2">SENSORES DO SISTEMA</div>
                <div class="grid grid-cols-4 gap-2">
                  <div class="text-center p-2 ${s0.class} rounded-lg">
                    <div class="text-sm font-bold">${s0.text}</div>
                    <div class="text-xs">0 Graus</div>
                  </div>
                  <div class="text-center p-2 ${s40.class} rounded-lg">
                    <div class="text-sm font-bold">${s40.text}</div>
                    <div class="text-xs">40 Graus</div>
                  </div>
                  <div class="text-center p-2 ${tRoda.class} rounded-lg">
                    <div class="text-sm font-bold">${tRoda.text}</div>
                    <div class="text-xs">Trava Roda</div>
                  </div>
                  <div class="text-center p-2 ${tChassi.class} rounded-lg">
                    <div class="text-sm font-bold">${tChassi.text}</div>
                    <div class="text-xs">Trava Chassi</div>
                  </div>
                  <div class="text-center p-2 ${tPinoE.class} rounded-lg">
                    <div class="text-sm font-bold">${tPinoE.text}</div>
                    <div class="text-xs">Pino E</div>
                  </div>
                  <div class="text-center p-2 ${tPinoD.class} rounded-lg">
                    <div class="text-sm font-bold">${tPinoD.text}</div>
                    <div class="text-xs">Pino D</div>
                  </div>
                  <div class="text-center p-2 ${moega.class} rounded-lg">
                    <div class="text-sm font-bold">${moega.text}</div>
                    <div class="text-xs">Moega</div>
                  </div>
                  <div class="text-center p-2 ${portao.class} rounded-lg">
                    <div class="text-sm font-bold">${portao.text}</div>
                    <div class="text-xs">Portao</div>
                  </div>
                </div>
              </div>

              <!-- Timeline 10 Etapas -->
              <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-xs font-bold text-gray-500">TIMELINE DAS 10 ETAPAS</span>
                  <span class="text-xs text-gray-400">Etapa: -</span>
                </div>
                <div class="flex gap-1 h-6">
                  ${[1,2,3,4,5,6,7,8,9,10].map(i => `<div class="flex-1 bg-gray-200 rounded text-center text-xs text-gray-400 flex items-center justify-center">${i}</div>`).join('')}
                </div>
              </div>

              <!-- Producao e Horimetro -->
              <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="text-center p-3 bg-pili-red/10 rounded-lg">
                  <div class="text-xl font-bold text-pili-red">${t.ciclos_hoje || 0}</div>
                  <div class="text-xs text-gray-500">Ciclos Hoje</div>
                </div>
                <div class="text-center p-3 bg-pili-red/10 rounded-lg">
                  <div class="text-xl font-bold text-pili-red">${(t.ciclos_total || 0).toLocaleString()}</div>
                  <div class="text-xs text-gray-500">Ciclos Total</div>
                </div>
                <div class="text-center p-3 bg-pili-red/10 rounded-lg">
                  <div class="text-xl font-bold text-pili-red">${t.horas_operacao || 0}h</div>
                  <div class="text-xs text-gray-500">Horimetro</div>
                </div>
              </div>

              <!-- Footer -->
              <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                <div>${subTag}</div>
                <p class="text-xs text-gray-400">Visto: ${lastSeen}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function viewDeviceDetails(serialNumber) {
      // Abrir modal com detalhes do dispositivo
      alert('Detalhes do dispositivo: ' + serialNumber);
    }

    async function loadStats() {
      try {
        const response = await api('/api/latest-readings');
        if (response && !response.blocked && response.data) {
          let totalCiclos = 0;
          let totalHoras = 0;
          response.data.forEach(d => {
            totalCiclos += (d.ciclos_total || 0);
            totalHoras += (d.horas_operacao || 0);
          });
          document.getElementById('statCiclos').textContent = totalCiclos.toLocaleString();
          document.getElementById('statHorimetro').textContent = totalHoras + 'h';
        }
      } catch (e) {
        console.log('Erro ao carregar stats:', e);
      }
    }

    // Load alerts
    async function loadAlerts() {
      const alerts = await api('/api/recent-alerts');
      if (!alerts) return;

      const list = document.getElementById('alertsList');

      if (alerts.length === 0) {
        list.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum alerta recente. Tudo funcionando normalmente!</div>';
        return;
      }

      list.innerHTML = alerts.slice(0, 10).map(a => `
        <div class="flex items-center gap-4 p-4 border rounded-lg ${a.event_type === 'ALERT' ? 'border-red-200 bg-red-50' : 'border-blue-200 bg-blue-50'}">
          <div class="w-10 h-10 rounded-full flex items-center justify-center ${a.event_type === 'ALERT' ? 'bg-red-100' : 'bg-blue-100'}">
            <svg class="w-5 h-5 ${a.event_type === 'ALERT' ? 'text-red-600' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${a.event_type === 'ALERT' ? 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' : 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}"/>
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${a.message}</p>
            <p class="text-sm text-gray-500">${new Date(a.timestamp).toLocaleString('pt-BR')}</p>
          </div>
        </div>
      `).join('');
    }

    // Check if timestamp is recent (< 10 min)
    function isRecent(timestamp) {
      if (!timestamp) return false;
      const diff = Date.now() - new Date(timestamp).getTime();
      return diff < 10 * 60 * 1000;
    }

    // Refresh all data
    async function refreshData() {
      document.getElementById('lastUpdate').textContent = 'Atualizando...';
      await Promise.all([
        loadStats(),
        loadDevices(),
        loadAlerts()
      ]);
      document.getElementById('lastUpdate').textContent = 'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');
    }

    // Initial load
    refreshData();
    checkFirstLogin();

    // Auto refresh every 30 seconds
    setInterval(refreshData, 30000);

    // ========== TOGGLE VIEW ALL IOTs ==========
    let viewAllMode = false;
    let allDevicesData = [];
    let allTelemetryData = {};

    function toggleViewAll() {
      viewAllMode = !viewAllMode;
      const panel = document.getElementById('allIoTsPanel');
      const btn = document.getElementById('btnViewAll');

      if (viewAllMode) {
        panel.classList.remove('hidden');
        btn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
          Voltar para Lista
        `;
        renderAllIoTs();
        // Auto refresh a cada 5 segundos
        if (!window.allIoTsInterval) {
          window.allIoTsInterval = setInterval(renderAllIoTs, 5000);
        }
      } else {
        panel.classList.add('hidden');
        btn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
          </svg>
          Ver Todos na Tela
        `;
        if (window.allIoTsInterval) {
          clearInterval(window.allIoTsInterval);
          window.allIoTsInterval = null;
        }
      }
    }

    async function renderAllIoTs() {
      const grid = document.getElementById('allIoTsGrid');
      const subtitle = document.getElementById('allIoTsSubtitle');
      const lastUpdateEl = document.getElementById('allIoTsLastUpdate');

      // Buscar dados
      const [devResponse, teleResponse] = await Promise.all([
        api('/api/devices'),
        api('/api/latest-readings')
      ]);

      if (!devResponse) {
        grid.innerHTML = '<div class="text-center py-8 text-gray-400">Erro ao carregar</div>';
        return;
      }

      const devices = devResponse.devices || [];
      const telemetryData = (teleResponse && !teleResponse.blocked) ? (teleResponse.data || []) : [];
      const telemetryMap = {};
      telemetryData.forEach(t => { telemetryMap[t.serial_number] = t; });

      const onlineCount = devices.filter(d => d.status_conexao === 'online').length;
      subtitle.textContent = `${devices.length} dispositivos | ${onlineCount} online`;
      lastUpdateEl.textContent = new Date().toLocaleTimeString('pt-BR');

      if (devices.length === 0) {
        grid.innerHTML = '<div class="text-center py-8 text-gray-400">Nenhum dispositivo encontrado</div>';
        return;
      }

      grid.innerHTML = devices.map(d => {
        const t = telemetryMap[d.serial_number] || {};
        const isOnline = d.status_conexao === 'online';
        const statusDot = isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500';
        const borderClass = isOnline ? 'border-green-500' : 'border-gray-600';

        // Status dos sensores (compacto)
        const sensorDot = (val) => val ? 'bg-green-500' : 'bg-red-500';

        return `
          <div class="bg-gray-800 border-2 ${borderClass} rounded-xl overflow-hidden transition-all hover:scale-[1.02]">
            <!-- Header -->
            <div class="bg-gradient-to-r from-pili-red to-pili-darkred p-3 flex items-center justify-between">
              <div>
                <h4 class="font-bold text-white text-sm">${d.name || 'Tombador'}</h4>
                <p class="text-white/60 text-xs">${d.serial_number}</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full ${statusDot}"></span>
              </div>
            </div>

            <div class="p-3">
              <!-- Sensores em grid compacto -->
              <div class="grid grid-cols-4 gap-1 mb-3">
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.sensor_0_graus)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">0°</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.sensor_40_graus)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">40°</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.trava_roda)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">Roda</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.trava_chassi)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">Chassi</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.trava_pino_e)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">Pin.E</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.trava_pino_d)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">Pin.D</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.moega_cheia)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">Moega</span>
                </div>
                <div class="flex flex-col items-center p-1">
                  <span class="w-3 h-3 rounded-full ${sensorDot(t.portao_fechado)}"></span>
                  <span class="text-[9px] text-gray-400 mt-1">Portao</span>
                </div>
              </div>

              <!-- Producao -->
              <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-gray-700 rounded-lg py-2">
                  <div class="text-lg font-black text-white">${t.ciclos_hoje || 0}</div>
                  <div class="text-[9px] text-gray-400">HOJE</div>
                </div>
                <div class="bg-gray-700 rounded-lg py-2">
                  <div class="text-lg font-black text-white">${(t.ciclos_total || 0).toLocaleString()}</div>
                  <div class="text-[9px] text-gray-400">TOTAL</div>
                </div>
                <div class="bg-gray-700 rounded-lg py-2">
                  <div class="text-lg font-black text-white">${t.horas_operacao || 0}h</div>
                  <div class="text-[9px] text-gray-400">HORIM.</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== TELEMETRIA E PRODUTIVIDADE ==========
    let chartCiclos, chartProdutividade, chartEtapas, chartPizza, chartHorario;
    let devicesList = [];
    const TEMPO_PADRAO_CICLO = 20 * 60; // 20 minutos em segundos

    // Populate device selector
    async function populateDeviceSelector() {
      const response = await api('/api/latest-readings');
      if (!response) return;

      const readings = response.data || response || [];
      devicesList = readings;
      const selector = document.getElementById('deviceSelector');
      selector.innerHTML = '<option value="">Selecione um dispositivo</option>';

      readings.forEach(d => {
        const option = document.createElement('option');
        option.value = d.serial_number;
        option.textContent = `${d.serial_number} - ${d.name || 'PILI TECH'}`;
        selector.appendChild(option);
      });

      // Auto-select first device
      if (readings.length > 0) {
        selector.value = readings[0].serial_number;
        loadTelemetry();
      }
    }

    // Load telemetry data
    async function loadTelemetry() {
      const serialNumber = document.getElementById('deviceSelector').value;
      if (!serialNumber) return;

      // Load device stats
      const stats = await api('/api/device-stats/' + serialNumber);
      if (stats) {
        // Calcular produtividade media
        const prodMedia = stats.produtividadeMedia || 100;
        document.getElementById('teleProdutividade').textContent = prodMedia.toFixed(0) + '%';

        // Atualizar gauge circular
        const gaugeProgress = document.getElementById('gaugeProgress');
        if (gaugeProgress) {
          const progressValue = Math.min(100, prodMedia);
          gaugeProgress.setAttribute('stroke-dasharray', `${progressValue}, 100`);
          gaugeProgress.setAttribute('stroke', prodMedia >= 100 ? '#22c55e' : prodMedia >= 80 ? '#eab308' : '#ef4444');
        }

        // Tempo medio por ciclo
        const tempoMedio = stats.tempoMedioCiclo || 0;
        document.getElementById('teleTempoCiclo').textContent = tempoMedio > 0 ? Math.round(tempoMedio / 60) + ' min' : '-';

        // Ciclos hoje
        document.getElementById('teleCiclosHoje').textContent = stats.ciclosHoje || 0;

        // Ciclos semana
        const ciclosSemana = stats.ciclosDiarios ? stats.ciclosDiarios.reduce((sum, d) => sum + parseInt(d.ciclos || 0), 0) : 0;
        document.getElementById('teleCiclosSemana').textContent = ciclosSemana;

        // Eficiencia
        const eficiencia = prodMedia >= 100 ? '+' + (prodMedia - 100).toFixed(0) + '%' : '-' + (100 - prodMedia).toFixed(0) + '%';
        document.getElementById('teleEficiencia').textContent = eficiencia;

        // Tendencia (comparar com ontem)
        if (stats.ciclosDiarios && stats.ciclosDiarios.length >= 2) {
          const hoje = parseInt(stats.ciclosHoje) || 0;
          const ontem = parseInt(stats.ciclosDiarios[stats.ciclosDiarios.length - 2]?.ciclos) || 0;
          const diff = hoje - ontem;
          const tendencia = diff > 0 ? `↑ +${diff} vs ontem` : diff < 0 ? `↓ ${diff} vs ontem` : '= igual ontem';
          document.getElementById('teleCiclosTendencia').textContent = tendencia;
        }

        // Update charts
        if (stats.ciclosDiarios) {
          updateCiclosChart(stats.ciclosDiarios);
          updateProdutividadeChart(stats.ciclosDiarios);
        }
      }

      // Load cycle data for timeline and table
      const cycleData = await api('/api/cycle-data/' + serialNumber);
      if (cycleData && cycleData.length > 0) {
        updateTimelineEtapas(cycleData[0]);
        updateEtapasChart(cycleData);
        updateCyclesTable(cycleData);
        updatePizzaChart(cycleData);
        updateIndicadores(cycleData);
      }

      // Load productivity data for hourly chart
      const prodData = await api('/api/productivity/' + serialNumber + '?days=1');
      if (prodData && prodData.cycles) {
        updateHorarioChart(prodData.cycles);
      }
    }

    // Update Pizza/Doughnut Chart (tempo por fase)
    function updatePizzaChart(data) {
      const ctx = document.getElementById('chartPizza');
      if (!ctx) return;

      if (chartPizza) chartPizza.destroy();

      // Calcular media das etapas principais
      const count = data.length || 1;
      const fases = {
        'Travamento': 0,
        'Subida': 0,
        'Descarga': 0,
        'Destravamento': 0
      };

      data.forEach(c => {
        // Travamento = etapas 1-5 (portao fecha ate travas)
        fases['Travamento'] += (c.etapa1_portao_aberto_fechado || 0) + (c.etapa2_portao_fechado_trava_roda || 0) + (c.etapa3_trava_roda_trava_chassi || 0) + (c.etapa4_trava_chassi_trava_pinos || 0);
        // Subida = etapa 5-6
        fases['Subida'] += (c.etapa5_trava_pinos_sensor0_inativo || 0);
        // Descarga = etapa 6
        fases['Descarga'] += (c.etapa6_sensor0_ativo_trava_pinos_inativo || 0);
        // Destravamento = etapas 7-10
        fases['Destravamento'] += (c.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0) + (c.etapa8_trava_chassi_inativo_trava_roda_inativo || 0) + (c.etapa9_trava_roda_inativo_portao_aberto || 0);
      });

      const labels = Object.keys(fases);
      const values = Object.values(fases).map(v => Math.round(v / count));

      chartPizza = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444', '#10b981'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } }
          }
        }
      });
    }

    // Update Hourly Chart
    function updateHorarioChart(cycles) {
      const ctx = document.getElementById('chartHorario');
      if (!ctx) return;

      if (chartHorario) chartHorario.destroy();

      // Agrupar por hora
      const hourly = {};
      for (let i = 0; i < 24; i++) hourly[i] = 0;

      cycles.forEach(c => {
        if (c.created_at) {
          const hour = new Date(c.created_at).getHours();
          hourly[hour]++;
        }
      });

      const labels = Object.keys(hourly).map(h => h + 'h');
      const values = Object.values(hourly);

      chartHorario = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Ciclos',
            data: values,
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Update Indicadores
    function updateIndicadores(data) {
      if (!data || data.length === 0) return;

      // Calcular medias das etapas
      const etapasNomes = ['Port.Fecha', 'Sen0°Inat', 'Tr.Roda', 'Tr.Chassi', 'Tr.Pinos', 'Sen0°Ativ', 'Solt.Roda', 'Solt.Chas', 'Solt.Pino', 'Port.Abre'];
      const etapasMedia = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      const count = data.length;

      data.forEach(c => {
        etapasMedia[0] += c.etapa1_portao_aberto_fechado || 0;
        etapasMedia[1] += c.etapa2_portao_fechado_trava_roda || 0;
        etapasMedia[2] += c.etapa3_trava_roda_trava_chassi || 0;
        etapasMedia[3] += c.etapa4_trava_chassi_trava_pinos || 0;
        etapasMedia[4] += c.etapa5_trava_pinos_sensor0_inativo || 0;
        etapasMedia[5] += c.etapa6_sensor0_ativo_trava_pinos_inativo || 0;
        etapasMedia[6] += c.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0;
        etapasMedia[7] += c.etapa8_trava_chassi_inativo_trava_roda_inativo || 0;
        etapasMedia[8] += c.etapa9_trava_roda_inativo_portao_aberto || 0;
        etapasMedia[9] += 0; // etapa 10 se houver
      });

      const medias = etapasMedia.map(v => Math.round(v / count));
      const maxTempo = Math.max(...medias);
      const minTempo = Math.min(...medias.filter(v => v > 0)) || 0;

      const maxIdx = medias.indexOf(maxTempo);
      const minIdx = medias.indexOf(minTempo);

      document.getElementById('etapaMaisRapida').textContent = `${etapasNomes[minIdx]} (${minTempo}s)`;
      document.getElementById('etapaMaisLenta').textContent = `${etapasNomes[maxIdx]} (${maxTempo}s)`;
      document.getElementById('barraRapida').style.width = (minTempo / maxTempo * 100) + '%';

      // Desvio padrao
      const temposTotal = data.map(c => c.tempo_total || 0);
      const mediaTempo = temposTotal.reduce((a, b) => a + b, 0) / count;
      const variancia = temposTotal.reduce((sum, t) => sum + Math.pow(t - mediaTempo, 2), 0) / count;
      const desvio = Math.sqrt(variancia);
      document.getElementById('desvioPadrao').textContent = Math.round(desvio) + 's';

      // Ciclos acima da meta
      const acimaMeta = data.filter(c => (c.tempo_total || 0) <= TEMPO_PADRAO_CICLO).length;
      const pctAcima = Math.round((acimaMeta / count) * 100);
      document.getElementById('ciclosAcimaMeta').textContent = `${acimaMeta}/${count} (${pctAcima}%)`;
    }

    // Format time in seconds to min:sec
    function formatTime(seconds) {
      if (!seconds || seconds <= 0) return '-';
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return min + ':' + String(sec).padStart(2, '0');
    }

    // Update Ciclos Chart
    function updateCiclosChart(data) {
      const ctx = document.getElementById('chartCiclos');
      if (!ctx) return;

      if (chartCiclos) chartCiclos.destroy();

      const labels = data.map(d => {
        const date = new Date(d.dia);
        return date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' });
      });
      const values = data.map(d => parseInt(d.ciclos) || 0);

      chartCiclos = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ciclos',
            data: values,
            backgroundColor: 'rgba(220, 38, 38, 0.7)',
            borderColor: 'rgb(220, 38, 38)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Update Produtividade Chart (%)
    function updateProdutividadeChart(data) {
      const ctx = document.getElementById('chartProdutividade');
      if (!ctx) return;

      if (chartProdutividade) chartProdutividade.destroy();

      const labels = data.map(d => {
        const date = new Date(d.dia);
        return date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' });
      });
      // Produtividade = (tempo_padrao / tempo_real) * 100
      const values = data.map(d => {
        const tempoReal = parseFloat(d.tempo_medio_ciclo) || TEMPO_PADRAO_CICLO;
        return Math.min(200, (TEMPO_PADRAO_CICLO / tempoReal) * 100);
      });

      chartProdutividade = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Produtividade %',
            data: values,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                line1: { type: 'line', yMin: 100, yMax: 100, borderColor: 'rgb(220, 38, 38)', borderWidth: 2, borderDash: [5, 5] }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 150,
              ticks: { callback: v => v + '%' }
            }
          }
        }
      });
    }

    // Update Timeline das 10 Etapas
    function updateTimelineEtapas(lastCycle) {
      const timeline = document.getElementById('timelineEtapas');
      if (!timeline || !lastCycle) return;

      // 10 etapas conforme firmware
      const etapas = [
        { nome: '1.Port.Fecha', tempo: lastCycle.etapa1_portao_aberto_fechado || 0 },
        { nome: '2.Sen0°Inat', tempo: lastCycle.etapa2_portao_fechado_trava_roda || 0 },
        { nome: '3.Tr.Roda', tempo: lastCycle.etapa3_trava_roda_trava_chassi || 0 },
        { nome: '4.Tr.Chassi', tempo: lastCycle.etapa4_trava_chassi_trava_pinos || 0 },
        { nome: '5.Tr.Pinos', tempo: lastCycle.etapa5_trava_pinos_sensor0_inativo || 0 },
        { nome: '6.Sen0°Ativ', tempo: lastCycle.etapa6_sensor0_ativo_trava_pinos_inativo || 0 },
        { nome: '7.Solt.Roda', tempo: lastCycle.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0 },
        { nome: '8.Solt.Chas', tempo: lastCycle.etapa8_trava_chassi_inativo_trava_roda_inativo || 0 },
        { nome: '9.Solt.Pino', tempo: lastCycle.etapa9_trava_roda_inativo_portao_aberto || 0 },
        { nome: '10.Port.Abre', tempo: 0 } // etapa 10 adicional
      ];

      const maxTempo = Math.max(...etapas.map(e => e.tempo), 1);

      timeline.innerHTML = etapas.map((e, i) => {
        const pct = (e.tempo / maxTempo) * 100;
        const bg = i === 5 ? 'bg-pili-red' : pct > 70 ? 'bg-red-400' : pct > 40 ? 'bg-yellow-400' : 'bg-green-400';
        // Etapa 6 é onde conta o ciclo
        const special = i === 5 ? 'ring-2 ring-white ring-offset-2 ring-offset-gray-100' : '';
        return `
          <div class="${bg} ${special} rounded p-1.5 text-center transition-all">
            <div class="text-[10px] font-bold text-white">${e.tempo}s</div>
            <div class="text-[6px] text-white/80">${e.nome}</div>
          </div>
        `;
      }).join('');
    }

    // Update Etapas Chart (bar) - 10 etapas
    function updateEtapasChart(data) {
      const ctx = document.getElementById('chartEtapas');
      if (!ctx) return;

      if (chartEtapas) chartEtapas.destroy();

      // Calcular media das 10 etapas
      const etapasMedia = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      const count = data.length;

      data.forEach(c => {
        etapasMedia[0] += c.etapa1_portao_aberto_fechado || 0;
        etapasMedia[1] += c.etapa2_portao_fechado_trava_roda || 0;
        etapasMedia[2] += c.etapa3_trava_roda_trava_chassi || 0;
        etapasMedia[3] += c.etapa4_trava_chassi_trava_pinos || 0;
        etapasMedia[4] += c.etapa5_trava_pinos_sensor0_inativo || 0;
        etapasMedia[5] += c.etapa6_sensor0_ativo_trava_pinos_inativo || 0;
        etapasMedia[6] += c.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0;
        etapasMedia[7] += c.etapa8_trava_chassi_inativo_trava_roda_inativo || 0;
        etapasMedia[8] += c.etapa9_trava_roda_inativo_portao_aberto || 0;
        etapasMedia[9] += 0; // etapa 10
      });

      const values = etapasMedia.map(v => Math.round(v / count) || 0);
      const labels = ['1.PortFecha', '2.Sen0°In', '3.TrRoda', '4.TrChas', '5.TrPinos', '6.Sen0°At', '7.SoltRod', '8.SoltCha', '9.SoltPin', '10.PortAb'];

      chartEtapas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Tempo (s)',
            data: values,
            backgroundColor: [
              'rgba(59, 130, 246, 0.8)',   // 1. Portao fecha - azul
              'rgba(16, 185, 129, 0.8)',   // 2. Sen 0° inativo - verde
              'rgba(16, 185, 129, 0.8)',   // 3. Trava roda - verde
              'rgba(16, 185, 129, 0.8)',   // 4. Trava chassi - verde
              'rgba(16, 185, 129, 0.8)',   // 5. Trava pinos - verde
              'rgba(220, 38, 38, 0.9)',    // 6. Sen 0° ativo - VERMELHO (conta ciclo)
              'rgba(239, 68, 68, 0.7)',    // 7. Solta roda - vermelho claro
              'rgba(239, 68, 68, 0.7)',    // 8. Solta chassi - vermelho claro
              'rgba(239, 68, 68, 0.7)',    // 9. Solta pinos - vermelho claro
              'rgba(59, 130, 246, 0.8)'    // 10. Portao abre - azul
            ],
            borderColor: [
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(220, 38, 38, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(59, 130, 246, 1)'
            ],
            borderWidth: 2,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Segundos' }, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { ticks: { font: { size: 9 } } }
          }
        }
      });
    }

    // Update Cycles Table - 10 etapas
    function updateCyclesTable(data) {
      const tbody = document.getElementById('cyclesTable');
      if (!tbody) return;

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Nenhum ciclo registrado</td></tr>';
        return;
      }

      tbody.innerHTML = data.slice(0, 20).map(c => {
        const produtividade = c.eficiencia || ((TEMPO_PADRAO_CICLO / c.tempo_total) * 100);
        const prodClass = produtividade >= 100 ? 'text-green-600 bg-green-50' : produtividade >= 80 ? 'text-yellow-600 bg-yellow-50' : 'text-red-600 bg-red-50';

        // Encontrar etapa mais lenta (10 etapas)
        const etapas = [
          { nome: 'Port.Fecha', tempo: c.etapa1_portao_aberto_fechado || 0 },
          { nome: 'Sen0°Inativo', tempo: c.etapa2_portao_fechado_trava_roda || 0 },
          { nome: 'Trava Roda', tempo: c.etapa3_trava_roda_trava_chassi || 0 },
          { nome: 'Trava Chassi', tempo: c.etapa4_trava_chassi_trava_pinos || 0 },
          { nome: 'Trava Pinos', tempo: c.etapa5_trava_pinos_sensor0_inativo || 0 },
          { nome: 'Sen0°Ativo ⬆', tempo: c.etapa6_sensor0_ativo_trava_pinos_inativo || 0 },
          { nome: 'Solta Roda', tempo: c.etapa7_trava_pinos_inativo_trava_chassi_inativo || 0 },
          { nome: 'Solta Chassi', tempo: c.etapa8_trava_chassi_inativo_trava_roda_inativo || 0 },
          { nome: 'Solta Pinos', tempo: c.etapa9_trava_roda_inativo_portao_aberto || 0 },
          { nome: 'Port.Abre', tempo: 0 }
        ];
        const maisLenta = etapas.reduce((a, b) => a.tempo > b.tempo ? a : b);

        return `
          <tr class="hover:bg-gray-50 border-b">
            <td class="px-4 py-3 text-xs text-gray-600">${c.timestamp ? new Date(c.timestamp).toLocaleString('pt-BR') : '-'}</td>
            <td class="px-4 py-3 text-center font-bold text-gray-800">#${c.ciclo_numero || '-'}</td>
            <td class="px-4 py-3 text-center font-medium">${Math.round((c.tempo_total || 0) / 60)} min</td>
            <td class="px-4 py-3 text-center">
              <span class="px-3 py-1 rounded-full text-sm font-bold ${prodClass}">${produtividade.toFixed(0)}%</span>
            </td>
            <td class="px-4 py-3 text-center text-xs text-red-500 font-medium">${maisLenta.nome} (${maisLenta.tempo}s)</td>
          </tr>
        `;
      }).join('');
    }

    // Initialize telemetry after main data loads
    setTimeout(populateDeviceSelector, 1000);
  </script>
</body>
</html>
