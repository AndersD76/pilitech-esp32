<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PILI TECH - Portal Administrativo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pili: { red: '#dc2626', darkred: '#991b1b', black: '#0a0a0a', green: '#22c55e' }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .sidebar { transition: width 0.3s ease; }
    .status-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">

    <!-- Sidebar -->
    <aside class="sidebar w-64 bg-gradient-to-b from-gray-900 to-gray-800 text-white flex flex-col">
      <!-- Logo -->
      <div class="p-6 border-b border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-pili-red rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-lg">PILI TECH</h1>
            <p class="text-xs text-gray-400">Super Admin</p>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 overflow-y-auto">
        <p class="text-xs text-gray-500 uppercase mb-2 px-4">Monitoramento</p>
        <ul class="space-y-1 mb-4">
          <li>
            <a href="#" onclick="showSection('dashboard')" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg bg-pili-red text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('dispositivos')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
              Dispositivos
            </a>
          </li>
        </ul>

        <p class="text-xs text-gray-500 uppercase mb-2 px-4">Gestao</p>
        <ul class="space-y-1 mb-4">
          <li>
            <a href="#" onclick="showSection('empresas')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Empresas
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('unidades')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              Unidades
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('usuarios')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
              Usuarios
            </a>
          </li>
        </ul>

        <p class="text-xs text-gray-500 uppercase mb-2 px-4">Financeiro</p>
        <ul class="space-y-1">
          <li>
            <a href="#" onclick="showSection('assinaturas')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
              Assinaturas
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('cupons')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
              Cupons de Desconto
            </a>
          </li>
        </ul>
      </nav>

      <!-- User Info -->
      <div class="p-4 border-t border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-pili-red rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
          </div>
          <div class="flex-1">
            <p class="text-sm font-medium" id="userName">Super Admin</p>
            <p class="text-xs text-pili-green">super_admin</p>
          </div>
          <button onclick="logout()" class="p-2 hover:bg-gray-700 rounded-lg" title="Sair">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
      <!-- Header -->
      <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold text-gray-800" id="pageTitle">Dashboard</h2>
          <p class="text-sm text-gray-500" id="pageSubtitle">Monitoramento em tempo real</p>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-500" id="lastUpdate">Atualizando...</span>
          <button onclick="refreshData()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          </button>
        </div>
      </header>

      <!-- Content Sections -->
      <div class="p-6">

        <!-- Dashboard Section -->
        <section id="sec-dashboard" class="section">
          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-gray-500 font-medium">Empresas</p>
                  <p class="text-2xl font-bold text-gray-800" id="statEmpresas">0</p>
                </div>
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-gray-500 font-medium">Dispositivos</p>
                  <p class="text-2xl font-bold text-gray-800" id="statDevices">0</p>
                </div>
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-gray-500 font-medium">Online</p>
                  <p class="text-2xl font-bold text-green-600" id="statOnline">0</p>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-gray-500 font-medium">Total Ciclos</p>
                  <p class="text-2xl font-bold text-gray-800" id="statCiclos">0</p>
                </div>
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs text-gray-500 font-medium">Assinaturas Ativas</p>
                  <p class="text-2xl font-bold text-pili-green" id="statAssinaturas">0</p>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Devices Grid -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Dispositivos IoT</h3>
            <div id="devicesGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
              <div class="text-center py-8 text-gray-500">Carregando...</div>
            </div>
          </div>
        </section>

        <!-- Dispositivos Section -->
        <section id="sec-dispositivos" class="section hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-800">Todos os Dispositivos</h3>
              <div class="flex gap-2">
                <select id="filterEmpresa" onchange="loadDevices()" class="px-3 py-2 border rounded-lg text-sm">
                  <option value="">Todas Empresas</option>
                </select>
                <button onclick="openDeviceModal()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                  Novo Dispositivo
                </button>
              </div>
            </div>
            <div id="allDevicesGrid" class="space-y-4">
              <div class="text-center py-8 text-gray-500">Carregando...</div>
            </div>
          </div>
        </section>

        <!-- Empresas Section -->
        <section id="sec-empresas" class="section hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-800">Empresas Cadastradas</h3>
              <button onclick="openEmpresaModal()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                Nova Empresa
              </button>
            </div>
            <div id="empresasList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="text-center py-8 text-gray-500 col-span-3">Carregando...</div>
            </div>
          </div>
        </section>

        <!-- Unidades Section -->
        <section id="sec-unidades" class="section hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-800">Unidades</h3>
              <div class="flex gap-2">
                <select id="filterEmpresaUnidades" onchange="loadUnidades()" class="px-3 py-2 border rounded-lg text-sm">
                  <option value="">Todas Empresas</option>
                </select>
                <button onclick="openUnidadeModal()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                  Nova Unidade
                </button>
              </div>
            </div>
            <div id="unidadesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="text-center py-8 text-gray-500 col-span-3">Carregando...</div>
            </div>
          </div>
        </section>

        <!-- Usuarios Section -->
        <section id="sec-usuarios" class="section hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-800">Usuarios do Sistema</h3>
              <div class="flex gap-2">
                <select id="filterEmpresaUsuarios" onchange="loadUsuarios()" class="px-3 py-2 border rounded-lg text-sm">
                  <option value="">Todas Empresas</option>
                </select>
                <button onclick="openUsuarioModal()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                  Novo Usuario
                </button>
              </div>
            </div>
            <div id="usuariosList" class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Nome</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Email</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Perfil</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Empresa</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Unidade</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Acoes</th>
                  </tr>
                </thead>
                <tbody id="usuariosTableBody">
                  <tr><td colspan="7" class="text-center py-8 text-gray-500">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Assinaturas Section -->
        <section id="sec-assinaturas" class="section hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-800">Assinaturas e Pagamentos</h3>
            </div>
            <div id="assinaturasList" class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Empresa</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">CNPJ</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Valor</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Metodo</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Data</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Acoes</th>
                  </tr>
                </thead>
                <tbody id="assinaturasTableBody">
                  <tr><td colspan="7" class="text-center py-8 text-gray-500">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Cupons de Desconto Section -->
        <section id="sec-cupons" class="section hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-800">Cupons de Desconto</h3>
              <button onclick="openCupomModal()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                Novo Cupom
              </button>
            </div>
            <div id="cuponsList" class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Codigo</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Desconto</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Tipo</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Validade</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Uso</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Acoes</th>
                  </tr>
                </thead>
                <tbody id="cuponsTableBody">
                  <tr><td colspan="7" class="text-center py-8 text-gray-500">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Modal Empresa -->
  <div id="empresaModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800" id="empresaModalTitle">Nova Empresa</h3>
        <button onclick="closeEmpresaModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="empresaForm" class="p-6 space-y-4">
        <input type="hidden" id="empresaId">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ *</label>
            <input type="text" id="empresaCnpj" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="00.000.000/0001-00">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Razao Social *</label>
            <input type="text" id="empresaRazao" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Fantasia</label>
            <input type="text" id="empresaNome" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input type="email" id="empresaEmail" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
            <input type="text" id="empresaTelefone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
            <input type="text" id="empresaCidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
            <input type="text" id="empresaEstado" maxlength="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="RS">
          </div>
        </div>
      </form>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeEmpresaModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="saveEmpresa()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Unidade -->
  <div id="unidadeModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800" id="unidadeModalTitle">Nova Unidade</h3>
        <button onclick="closeUnidadeModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="unidadeForm" class="p-6 space-y-4">
        <input type="hidden" id="unidadeId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
          <select id="unidadeEmpresa" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
            <option value="">Selecione...</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Unidade *</label>
            <input type="text" id="unidadeNome" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Codigo</label>
            <input type="text" id="unidadeCodigo" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="MATRIZ">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Responsavel</label>
            <input type="text" id="unidadeResponsavel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
            <input type="text" id="unidadeCidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
            <input type="text" id="unidadeEstado" maxlength="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="RS">
          </div>
        </div>
      </form>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeUnidadeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="saveUnidade()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Usuario -->
  <div id="usuarioModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800" id="usuarioModalTitle">Novo Usuario</h3>
        <button onclick="closeUsuarioModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="usuarioForm" class="p-6 space-y-4">
        <input type="hidden" id="usuarioId">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
            <input type="text" id="usuarioNome" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input type="email" id="usuarioEmail" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Senha *</label>
            <input type="password" id="usuarioSenha" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="Deixe vazio para manter">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
            <input type="text" id="usuarioTelefone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Perfil *</label>
            <select id="usuarioRole" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
              <option value="operador">Operador</option>
              <option value="admin_unidade">Admin Unidade</option>
              <option value="admin_empresa">Admin Empresa</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="usuarioActive" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
              <option value="true">Ativo</option>
              <option value="false">Inativo</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
            <select id="usuarioEmpresa" onchange="loadUnidadesSelect()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
              <option value="">Nenhuma (Super Admin)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
            <select id="usuarioUnidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
              <option value="">Todas da Empresa</option>
            </select>
          </div>
        </div>
      </form>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeUsuarioModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="saveUsuario()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Dispositivo -->
  <div id="deviceModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800" id="deviceModalTitle">Novo Dispositivo IoT</h3>
        <button onclick="closeDeviceModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="deviceForm" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Numero de Serie *</label>
          <input type="text" id="deviceSerial" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="Ex: ESP32-001">
          <p class="text-xs text-gray-500 mt-1">Este e o identificador unico do dispositivo IoT</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nome/Descricao</label>
          <input type="text" id="deviceName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="Tombador" value="Tombador">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Empresa (CNPJ)</label>
          <select id="deviceEmpresa" onchange="loadUnidadesDevice()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
            <option value="">Sem vinculo (cadastrar depois)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
          <select id="deviceUnidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
            <option value="">Selecione a empresa primeiro</option>
          </select>
        </div>
      </form>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeDeviceModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="saveDevice()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Cadastrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Vincular Dispositivo -->
  <div id="vincularModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800">Vincular Dispositivo</h3>
        <button onclick="closeVincularModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="vincularSerial">
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-sm text-gray-500">Dispositivo</p>
          <p class="font-bold text-gray-800" id="vincularSerialDisplay">-</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
          <select id="vincularEmpresa" onchange="loadUnidadesVincular()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
            <option value="">Selecione a empresa...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Unidade *</label>
          <select id="vincularUnidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
            <option value="">Selecione a empresa primeiro</option>
          </select>
        </div>
      </div>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeVincularModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="confirmarVinculo()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Vincular</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Unidade -->
  <div id="editUnidadeModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800">Editar Unidade</h3>
        <button onclick="closeEditUnidadeModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="editUnidadeForm" class="p-6 space-y-4">
        <input type="hidden" id="editUnidadeId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
          <input type="text" id="editUnidadeEmpresa" disabled class="w-full px-4 py-2 border rounded-lg bg-gray-100 text-gray-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Unidade *</label>
            <input type="text" id="editUnidadeNome" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Codigo</label>
            <input type="text" id="editUnidadeCodigo" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="MATRIZ">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Responsavel</label>
            <input type="text" id="editUnidadeResponsavel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
            <input type="text" id="editUnidadeCidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
            <input type="text" id="editUnidadeEstado" maxlength="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="RS">
          </div>
        </div>
      </form>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeEditUnidadeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="saveEditUnidade()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Cupom -->
  <div id="cupomModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800" id="cupomModalTitle">Novo Cupom de Desconto</h3>
        <button onclick="closeCupomModal()" class="p-2 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="cupomForm" class="p-6 space-y-4">
        <input type="hidden" id="cupomId">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Codigo do Cupom *</label>
            <input type="text" id="cupomCodigo" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent uppercase" placeholder="DESCONTO10">
            <p class="text-xs text-gray-500 mt-1">Codigo que o cliente digitara no checkout</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Desconto *</label>
            <select id="cupomTipo" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
              <option value="percentual">Percentual (%)</option>
              <option value="valor">Valor Fixo (R$)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Valor do Desconto *</label>
            <input type="number" id="cupomValor" required min="1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="10">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Data de Validade</label>
            <input type="date" id="cupomValidade" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent">
            <p class="text-xs text-gray-500 mt-1">Deixe vazio para sem limite</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Limite de Uso</label>
            <input type="number" id="cupomLimiteUso" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="0 = ilimitado">
            <p class="text-xs text-gray-500 mt-1">0 = uso ilimitado</p>
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Descricao (opcional)</label>
            <input type="text" id="cupomDescricao" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pili-red focus:border-transparent" placeholder="Promocao de lancamento">
          </div>
        </div>
      </form>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeCupomModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button onclick="saveCupom()" class="px-4 py-2 bg-pili-red text-white rounded-lg hover:bg-pili-darkred">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('pilitech_token');
    let user = null;
    let empresasList = [];

    // Check authentication
    async function checkAuth() {
      if (!token) {
        window.location.href = '/';
        return false;
      }

      try {
        const res = await fetch('/api/verify', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) throw new Error('Token invalido');

        const data = await res.json();
        user = data.user;

        if (!['super_admin', 'admin'].includes(user.role)) {
          alert('Acesso negado. Apenas Super Admin.');
          window.location.href = '/cliente.html';
          return false;
        }

        document.getElementById('userName').textContent = user.nome || 'Super Admin';
        return true;
      } catch (err) {
        console.error('Auth error:', err);
        window.location.href = '/';
        return false;
      }
    }

    // API helper
    async function api(endpoint, options = {}) {
      const res = await fetch(endpoint, {
        ...options,
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (res.status === 401) {
        logout();
        return null;
      }

      return res.json();
    }

    // Logout
    function logout() {
      localStorage.removeItem('pilitech_token');
      localStorage.removeItem('pilitech_user');
      window.location.href = '/';
    }

    // Show section
    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      document.getElementById('sec-' + name).classList.remove('hidden');

      document.querySelectorAll('.nav-link').forEach(l => {
        l.classList.remove('active', 'bg-pili-red', 'text-white');
        l.classList.add('text-gray-300', 'hover:bg-gray-700');
      });

      event.target.closest('.nav-link').classList.add('active', 'bg-pili-red', 'text-white');
      event.target.closest('.nav-link').classList.remove('text-gray-300', 'hover:bg-gray-700');

      const titles = {
        dashboard: ['Dashboard', 'Monitoramento em tempo real'],
        dispositivos: ['Dispositivos', 'Gerenciar dispositivos IoT'],
        empresas: ['Empresas', 'Gerenciar empresas cadastradas'],
        unidades: ['Unidades', 'Gerenciar unidades/filiais'],
        usuarios: ['Usuarios', 'Gerenciar usuarios do sistema'],
        assinaturas: ['Assinaturas', 'Gerenciar assinaturas e pagamentos'],
        cupons: ['Cupons de Desconto', 'Gerenciar cupons promocionais']
      };
      document.getElementById('pageTitle').textContent = titles[name]?.[0] || name;
      document.getElementById('pageSubtitle').textContent = titles[name]?.[1] || '';

      // Load section data
      if (name === 'empresas') loadEmpresas();
      if (name === 'unidades') loadUnidades();
      if (name === 'usuarios') loadUsuarios();
      if (name === 'assinaturas') loadAssinaturas();
      if (name === 'cupons') loadCupons();
    }

    // Load stats
    async function loadStats() {
      const stats = await api('/api/stats');
      if (stats && !stats.blocked) {
        document.getElementById('statDevices').textContent = stats.totalDevices || 0;
        document.getElementById('statOnline').textContent = stats.onlineDevices || 0;
        document.getElementById('statCiclos').textContent = (stats.totalCiclos || 0).toLocaleString();
      }

      // Load empresas count
      const empresas = await api('/api/empresas');
      if (empresas) {
        document.getElementById('statEmpresas').textContent = empresas.length;
        empresasList = empresas;
        updateEmpresasSelects();

        // Count active subscriptions
        const active = empresas.filter(e => e.status === 'active' || e.status === 'trial').length;
        document.getElementById('statAssinaturas').textContent = active;
      }
    }

    // Update all empresas selects
    function updateEmpresasSelects() {
      const selects = ['filterEmpresa', 'filterEmpresaUnidades', 'filterEmpresaUsuarios', 'unidadeEmpresa', 'usuarioEmpresa'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;

        const currentValue = select.value;
        const isRequired = id === 'unidadeEmpresa';

        select.innerHTML = isRequired
          ? '<option value="">Selecione...</option>'
          : '<option value="">Todas Empresas</option>';

        empresasList.forEach(e => {
          select.innerHTML += `<option value="${e.id}">${e.razao_social}</option>`;
        });

        if (currentValue) select.value = currentValue;
      });
    }

    // Load devices
    async function loadDevices() {
      const result = await api('/api/devices');
      if (!result) return;

      const devices = result.devices || [];
      const grid = document.getElementById('devicesGrid');
      const allGrid = document.getElementById('allDevicesGrid');

      if (devices.length === 0) {
        grid.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-3">Nenhum dispositivo encontrado</div>';
        allGrid.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum dispositivo encontrado</div>';
        return;
      }

      grid.innerHTML = devices.map(d => renderDeviceCard(d)).join('');
      allGrid.innerHTML = devices.map(d => renderDeviceCardFull(d)).join('');
    }

    function renderDeviceCard(d) {
      const isOnline = d.status_conexao === 'online';
      const statusClass = isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
      const statusText = isOnline ? 'Online' : 'Offline';

      return `
        <div class="border rounded-xl p-4 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h4 class="font-bold text-gray-800">${d.serial_number}</h4>
              <p class="text-sm text-gray-500">${d.name || 'Tombador'}</p>
              ${d.empresa_nome ? `<p class="text-xs text-gray-400">${d.empresa_nome}</p>` : '<p class="text-xs text-orange-500">Sem empresa</p>'}
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">${statusText}</span>
          </div>
        </div>
      `;
    }

    function renderDeviceCardFull(d) {
      const isOnline = d.status_conexao === 'online';
      const statusClass = isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
      const statusText = isOnline ? 'Online' : d.status_conexao === 'idle' ? 'Idle' : 'Offline';

      // Tag de assinatura
      let subscriptionTag = '';
      if (d.subscription_info && d.subscription_info.active) {
        const expiresAt = new Date(d.subscription_info.expires_at);
        const expiresStr = expiresAt.toLocaleDateString('pt-BR');
        const isDeviceSub = d.subscription_info.type === 'device';
        const isTrial = d.subscription_info.status === 'trial';
        if (isTrial) {
          const daysLeft = Math.ceil((expiresAt - new Date()) / (1000*60*60*24));
          subscriptionTag = `
            <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
              Trial: ${daysLeft} dias restantes
            </span>
          `;
        } else {
          subscriptionTag = `
            <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
              Assinado ate ${expiresStr} ${isDeviceSub ? '(IoT)' : '(Empresa)'}
            </span>
          `;
        }
      } else {
        subscriptionTag = `
          <span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">
            Sem assinatura
          </span>
        `;
      }

      return `
        <div class="border rounded-xl p-6 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="font-bold text-lg text-gray-800">${d.serial_number}</h4>
              <p class="text-sm text-gray-500">${d.name || 'Tombador'}</p>
              ${d.empresa_nome
                ? `<p class="text-xs text-gray-400">${d.empresa_nome} ${d.unidade_nome ? '> ' + d.unidade_nome : ''}</p>`
                : '<p class="text-xs text-orange-500">Dispositivo sem vinculo - aguardando configuracao</p>'}
              <div class="mt-2">${subscriptionTag}</div>
            </div>
            <span class="px-4 py-2 rounded-full text-sm font-bold ${statusClass}">${statusText}</span>
          </div>
          <div class="flex gap-2 mt-4">
            <button onclick="vincularDispositivo('${d.serial_number}')" class="px-3 py-1 text-sm border rounded-lg hover:bg-gray-50">
              Vincular
            </button>
            ${d.unidade_id ? `
              <button onclick="desvincularDispositivo('${d.serial_number}')" class="px-3 py-1 text-sm border border-yellow-300 text-yellow-600 rounded-lg hover:bg-yellow-50">
                Desvincular
              </button>
            ` : ''}
            <button onclick="deleteDispositivo('${d.serial_number}')" class="px-3 py-1 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50">
              Excluir
            </button>
          </div>
        </div>
      `;
    }

    // Load empresas
    async function loadEmpresas() {
      const empresas = await api('/api/empresas');
      if (!empresas) return;

      empresasList = empresas;
      updateEmpresasSelects();

      const list = document.getElementById('empresasList');

      if (empresas.length === 0) {
        list.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-3">Nenhuma empresa cadastrada</div>';
        return;
      }

      list.innerHTML = empresas.map(e => {
        const statusColors = {
          trial: 'bg-yellow-100 text-yellow-700',
          active: 'bg-green-100 text-green-700',
          expired: 'bg-red-100 text-red-700'
        };
        const statusLabels = {
          trial: `Trial (${e.status === 'trial' ? Math.ceil((new Date(e.valid_until) - new Date()) / (1000*60*60*24)) : 0} dias)`,
          active: 'Assinatura Ativa',
          expired: 'Expirado'
        };

        return `
          <div class="bg-gray-50 rounded-xl p-6">
            <div class="flex items-start justify-between mb-4">
              <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
              </div>
              <span class="px-2 py-1 text-xs rounded-full ${statusColors[e.status] || 'bg-gray-100'}">${statusLabels[e.status] || e.status}</span>
            </div>
            <h4 class="font-bold text-gray-800">${e.razao_social}</h4>
            ${e.nome_fantasia ? `<p class="text-sm text-gray-600">${e.nome_fantasia}</p>` : ''}
            <p class="text-xs text-gray-400 mt-1">${e.cnpj}</p>
            <div class="mt-4 pt-4 border-t grid grid-cols-3 gap-2 text-center text-xs">
              <div>
                <div class="font-bold text-gray-800">${e.total_unidades || 0}</div>
                <div class="text-gray-500">Unidades</div>
              </div>
              <div>
                <div class="font-bold text-gray-800">${e.total_devices || 0}</div>
                <div class="text-gray-500">Dispositivos</div>
              </div>
              <div>
                <div class="font-bold text-gray-800">${e.total_usuarios || 0}</div>
                <div class="text-gray-500">Usuarios</div>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button onclick="editEmpresa(${e.id})" class="flex-1 px-3 py-2 text-sm border rounded-lg hover:bg-gray-100">Editar</button>
              <button onclick="deleteEmpresa(${e.id}, '${e.razao_social.replace(/'/g, "\\'")}')" class="px-3 py-2 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50">Excluir</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Load unidades
    async function loadUnidades() {
      const empresaId = document.getElementById('filterEmpresaUnidades')?.value;
      const url = empresaId ? `/api/unidades?empresa_id=${empresaId}` : '/api/unidades';
      const unidades = await api(url);
      if (!unidades) return;

      const list = document.getElementById('unidadesList');

      if (unidades.length === 0) {
        list.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-3">Nenhuma unidade cadastrada</div>';
        return;
      }

      list.innerHTML = unidades.map(u => `
        <div class="bg-gray-50 rounded-xl p-6">
          <div class="flex items-start justify-between mb-4">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              </svg>
            </div>
            <span class="px-2 py-1 text-xs bg-gray-200 rounded">${u.codigo || 'SEM COD'}</span>
          </div>
          <h4 class="font-bold text-gray-800">${u.nome}</h4>
          <p class="text-sm text-gray-500">${u.empresa_nome}</p>
          ${u.cidade ? `<p class="text-xs text-gray-400 mt-1">${u.cidade}${u.estado ? '/' + u.estado : ''}</p>` : ''}
          <div class="mt-4 pt-4 border-t">
            <div class="text-center mb-3">
              <div class="font-bold text-gray-800">${u.total_devices || 0}</div>
              <div class="text-xs text-gray-500">Dispositivos</div>
            </div>
            <div class="flex gap-2">
              <button onclick="editUnidade(${u.id})" class="flex-1 px-3 py-2 text-sm border rounded-lg hover:bg-gray-100">Editar</button>
              <button onclick="deleteUnidade(${u.id}, '${u.nome.replace(/'/g, "\\'")}', ${u.total_devices || 0})" class="px-3 py-2 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50">Excluir</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Load usuarios
    async function loadUsuarios() {
      const empresaId = document.getElementById('filterEmpresaUsuarios')?.value;
      const url = empresaId ? `/api/usuarios?empresa_id=${empresaId}` : '/api/usuarios';
      const usuarios = await api(url);
      if (!usuarios) return;

      const tbody = document.getElementById('usuariosTableBody');

      if (usuarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">Nenhum usuario cadastrado</td></tr>';
        return;
      }

      const roleLabels = {
        super_admin: 'Super Admin',
        admin_empresa: 'Admin Empresa',
        admin_unidade: 'Admin Unidade',
        operador: 'Operador'
      };

      const roleColors = {
        super_admin: 'bg-purple-100 text-purple-700',
        admin_empresa: 'bg-blue-100 text-blue-700',
        admin_unidade: 'bg-green-100 text-green-700',
        operador: 'bg-gray-100 text-gray-700'
      };

      tbody.innerHTML = usuarios.map(u => `
        <tr class="border-b hover:bg-gray-50">
          <td class="py-3 px-4">
            <div class="font-medium text-gray-800">${u.nome}</div>
            ${u.telefone ? `<div class="text-xs text-gray-400">${u.telefone}</div>` : ''}
          </td>
          <td class="py-3 px-4 text-gray-600">${u.email}</td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 text-xs rounded-full ${roleColors[u.role] || 'bg-gray-100'}">${roleLabels[u.role] || u.role}</span>
          </td>
          <td class="py-3 px-4 text-gray-600">${u.empresa_nome || '-'}</td>
          <td class="py-3 px-4 text-gray-600">${u.unidade_nome || 'Todas'}</td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 text-xs rounded-full ${u.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
              ${u.active ? 'Ativo' : 'Inativo'}
            </span>
          </td>
          <td class="py-3 px-4 text-right flex gap-1 justify-end">
            <button onclick="editUsuario(${u.id})" class="p-2 hover:bg-gray-200 rounded-lg" title="Editar">
              <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            </button>
            <button onclick="deleteUsuario(${u.id}, '${u.nome}')" class="p-2 hover:bg-red-100 rounded-lg" title="Excluir">
              <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Load assinaturas
    async function loadAssinaturas() {
      const subs = await api('/api/subscriptions');
      if (!subs) return;

      const tbody = document.getElementById('assinaturasTableBody');

      if (subs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">Nenhuma assinatura encontrada</td></tr>';
        return;
      }

      const statusColors = {
        pending: 'bg-yellow-100 text-yellow-700',
        processing: 'bg-blue-100 text-blue-700',
        paid: 'bg-green-100 text-green-700',
        failed: 'bg-red-100 text-red-700',
        cancelled: 'bg-gray-100 text-gray-700',
        expired: 'bg-red-100 text-red-700'
      };

      tbody.innerHTML = subs.map(s => `
        <tr class="border-b hover:bg-gray-50">
          <td class="py-3 px-4">
            <div class="font-medium text-gray-800">${s.razao_social}</div>
            ${s.device_serial ? `<div class="text-xs text-blue-600">IoT: ${s.device_serial} - ${s.device_name || 'Tombador'}</div>` : '<div class="text-xs text-gray-400">Todos os IoTs</div>'}
          </td>
          <td class="py-3 px-4 text-gray-600">${s.cnpj}</td>
          <td class="py-3 px-4 text-gray-600">R$ ${parseFloat(s.amount).toFixed(2).replace('.', ',')}</td>
          <td class="py-3 px-4 text-gray-600">${s.payment_method === 'pix' ? 'PIX' : `Cartao ${s.installments}x`}</td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 text-xs rounded-full ${statusColors[s.status] || 'bg-gray-100'}">${s.status}</span>
          </td>
          <td class="py-3 px-4 text-gray-600">${new Date(s.created_at).toLocaleDateString('pt-BR')}</td>
          <td class="py-3 px-4 text-right flex gap-2 justify-end">
            ${s.status === 'pending' || s.status === 'processing' ? `
              <button onclick="confirmPayment(${s.id})" class="px-3 py-1 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700">
                Confirmar
              </button>
            ` : ''}
            <button onclick="deleteSubscription(${s.id})" class="px-3 py-1 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50">
              Excluir
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Modal functions - Empresa
    function openEmpresaModal(id = null) {
      document.getElementById('empresaForm').reset();
      document.getElementById('empresaId').value = '';
      document.getElementById('empresaModalTitle').textContent = id ? 'Editar Empresa' : 'Nova Empresa';

      document.getElementById('empresaModal').classList.remove('hidden');
      document.getElementById('empresaModal').classList.add('flex');
    }

    function closeEmpresaModal() {
      document.getElementById('empresaModal').classList.add('hidden');
      document.getElementById('empresaModal').classList.remove('flex');
    }

    async function editEmpresa(id) {
      const empresa = await api('/api/empresas/' + id);
      if (!empresa) return;

      document.getElementById('empresaId').value = empresa.id;
      document.getElementById('empresaCnpj').value = empresa.cnpj;
      document.getElementById('empresaRazao').value = empresa.razao_social;
      document.getElementById('empresaNome').value = empresa.nome_fantasia || '';
      document.getElementById('empresaEmail').value = empresa.email || '';
      document.getElementById('empresaTelefone').value = empresa.telefone || '';
      document.getElementById('empresaCidade').value = empresa.cidade || '';
      document.getElementById('empresaEstado').value = empresa.estado || '';

      document.getElementById('empresaModalTitle').textContent = 'Editar Empresa';
      document.getElementById('empresaModal').classList.remove('hidden');
      document.getElementById('empresaModal').classList.add('flex');
    }

    async function saveEmpresa() {
      const id = document.getElementById('empresaId').value;
      const data = {
        cnpj: document.getElementById('empresaCnpj').value,
        razao_social: document.getElementById('empresaRazao').value,
        nome_fantasia: document.getElementById('empresaNome').value,
        email: document.getElementById('empresaEmail').value,
        telefone: document.getElementById('empresaTelefone').value,
        cidade: document.getElementById('empresaCidade').value,
        estado: document.getElementById('empresaEstado').value
      };

      if (!data.cnpj || !data.razao_social) {
        alert('CNPJ e Razao Social sao obrigatorios');
        return;
      }

      const url = id ? '/api/empresas/' + id : '/api/empresas';
      const method = id ? 'PUT' : 'POST';

      const result = await api(url, { method, body: JSON.stringify(data) });

      if (result?.success || result?.id) {
        closeEmpresaModal();
        loadEmpresas();
        loadStats();
        alert(id ? 'Empresa atualizada!' : 'Empresa criada com 30 dias de trial!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Modal functions - Unidade
    function openUnidadeModal() {
      document.getElementById('unidadeForm').reset();
      document.getElementById('unidadeId').value = '';
      document.getElementById('unidadeModalTitle').textContent = 'Nova Unidade';

      document.getElementById('unidadeModal').classList.remove('hidden');
      document.getElementById('unidadeModal').classList.add('flex');
    }

    function closeUnidadeModal() {
      document.getElementById('unidadeModal').classList.add('hidden');
      document.getElementById('unidadeModal').classList.remove('flex');
    }

    async function saveUnidade() {
      const data = {
        empresa_id: document.getElementById('unidadeEmpresa').value,
        nome: document.getElementById('unidadeNome').value,
        codigo: document.getElementById('unidadeCodigo').value,
        responsavel: document.getElementById('unidadeResponsavel').value,
        cidade: document.getElementById('unidadeCidade').value,
        estado: document.getElementById('unidadeEstado').value
      };

      if (!data.empresa_id || !data.nome) {
        alert('Empresa e Nome sao obrigatorios');
        return;
      }

      const result = await api('/api/unidades', { method: 'POST', body: JSON.stringify(data) });

      if (result?.success || result?.id) {
        closeUnidadeModal();
        loadUnidades();
        alert('Unidade criada!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Modal functions - Usuario
    function openUsuarioModal() {
      document.getElementById('usuarioForm').reset();
      document.getElementById('usuarioId').value = '';
      document.getElementById('usuarioModalTitle').textContent = 'Novo Usuario';
      document.getElementById('usuarioSenha').placeholder = '';
      document.getElementById('usuarioSenha').required = true;

      document.getElementById('usuarioModal').classList.remove('hidden');
      document.getElementById('usuarioModal').classList.add('flex');
    }

    function closeUsuarioModal() {
      document.getElementById('usuarioModal').classList.add('hidden');
      document.getElementById('usuarioModal').classList.remove('flex');
    }

    async function loadUnidadesSelect() {
      const empresaId = document.getElementById('usuarioEmpresa').value;
      const select = document.getElementById('usuarioUnidade');
      select.innerHTML = '<option value="">Todas da Empresa</option>';

      if (!empresaId) return;

      const unidades = await api('/api/unidades?empresa_id=' + empresaId);
      if (unidades) {
        unidades.forEach(u => {
          select.innerHTML += `<option value="${u.id}">${u.nome}</option>`;
        });
      }
    }

    async function editUsuario(id) {
      // Carregar dados do usuario
      const usuario = await api('/api/usuarios/' + id);
      if (!usuario || usuario.error) {
        alert('Erro ao carregar usuario: ' + (usuario?.error || 'Usuario nao encontrado'));
        return;
      }

      document.getElementById('usuarioId').value = usuario.id;
      document.getElementById('usuarioNome').value = usuario.nome || '';
      document.getElementById('usuarioEmail').value = usuario.email || '';
      document.getElementById('usuarioSenha').value = '';
      document.getElementById('usuarioSenha').placeholder = 'Deixe vazio para manter';
      document.getElementById('usuarioSenha').required = false;
      document.getElementById('usuarioTelefone').value = usuario.telefone || '';
      document.getElementById('usuarioRole').value = usuario.role || 'operador';
      document.getElementById('usuarioActive').value = usuario.active ? 'true' : 'false';
      document.getElementById('usuarioEmpresa').value = usuario.empresa_id || '';

      // Carregar unidades da empresa selecionada
      if (usuario.empresa_id) {
        await loadUnidadesSelect();
        document.getElementById('usuarioUnidade').value = usuario.unidade_id || '';
      }

      document.getElementById('usuarioModalTitle').textContent = 'Editar Usuario';
      document.getElementById('usuarioModal').classList.remove('hidden');
      document.getElementById('usuarioModal').classList.add('flex');
    }

    async function saveUsuario() {
      const id = document.getElementById('usuarioId').value;
      const data = {
        nome: document.getElementById('usuarioNome').value,
        email: document.getElementById('usuarioEmail').value,
        password: document.getElementById('usuarioSenha').value || undefined,
        telefone: document.getElementById('usuarioTelefone').value,
        role: document.getElementById('usuarioRole').value,
        active: document.getElementById('usuarioActive').value === 'true',
        empresa_id: document.getElementById('usuarioEmpresa').value || null,
        unidade_id: document.getElementById('usuarioUnidade').value || null
      };

      if (!data.nome || !data.email) {
        alert('Nome e Email sao obrigatorios');
        return;
      }

      if (!id && !data.password) {
        alert('Senha e obrigatoria para novos usuarios');
        return;
      }

      const url = id ? '/api/usuarios/' + id : '/api/usuarios';
      const method = id ? 'PUT' : 'POST';

      const result = await api(url, { method, body: JSON.stringify(data) });

      if (result?.success || result?.id) {
        closeUsuarioModal();
        loadUsuarios();
        alert(id ? 'Usuario atualizado!' : 'Usuario criado!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Excluir usuario
    async function deleteUsuario(id, nome) {
      if (!confirm(`Tem certeza que deseja excluir o usuario "${nome}"?\nEssa acao nao pode ser desfeita.`)) return;

      const result = await api('/api/usuarios/' + id, { method: 'DELETE' });

      if (result?.success) {
        loadUsuarios();
        loadStats();
        alert('Usuario excluido com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Confirm payment
    async function confirmPayment(subscriptionId) {
      if (!confirm('Confirmar pagamento manualmente?')) return;

      const result = await api('/api/payment/confirm/' + subscriptionId, { method: 'POST' });

      if (result?.success) {
        loadAssinaturas();
        loadEmpresas();
        loadStats();
        alert('Pagamento confirmado!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Delete subscription
    async function deleteSubscription(subscriptionId) {
      if (!confirm('Tem certeza que deseja excluir esta assinatura?')) return;

      const result = await api('/api/subscriptions/' + subscriptionId, { method: 'DELETE' });

      if (result?.success) {
        loadAssinaturas();
        loadEmpresas();
        loadDevices();
        loadStats();
        alert('Assinatura excluida!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Modal functions - Device
    function openDeviceModal() {
      document.getElementById('deviceForm').reset();
      document.getElementById('deviceName').value = 'Tombador';
      document.getElementById('deviceModalTitle').textContent = 'Novo Dispositivo IoT';

      // Popular select de empresas
      const select = document.getElementById('deviceEmpresa');
      select.innerHTML = '<option value="">Sem vinculo (cadastrar depois)</option>';
      empresasList.forEach(e => {
        select.innerHTML += `<option value="${e.id}">${e.razao_social} (${e.cnpj})</option>`;
      });

      document.getElementById('deviceUnidade').innerHTML = '<option value="">Selecione a empresa primeiro</option>';

      document.getElementById('deviceModal').classList.remove('hidden');
      document.getElementById('deviceModal').classList.add('flex');
    }

    function closeDeviceModal() {
      document.getElementById('deviceModal').classList.add('hidden');
      document.getElementById('deviceModal').classList.remove('flex');
    }

    async function loadUnidadesDevice() {
      const empresaId = document.getElementById('deviceEmpresa').value;
      const select = document.getElementById('deviceUnidade');

      if (!empresaId) {
        select.innerHTML = '<option value="">Selecione a empresa primeiro</option>';
        return;
      }

      select.innerHTML = '<option value="">Carregando...</option>';

      const unidades = await api('/api/unidades?empresa_id=' + empresaId);
      if (unidades && unidades.length > 0) {
        select.innerHTML = '<option value="">Selecione a unidade</option>';
        unidades.forEach(u => {
          select.innerHTML += `<option value="${u.id}">${u.nome} ${u.codigo ? '(' + u.codigo + ')' : ''}</option>`;
        });
      } else {
        select.innerHTML = '<option value="">Nenhuma unidade cadastrada</option>';
      }
    }

    async function saveDevice() {
      const data = {
        serial_number: document.getElementById('deviceSerial').value.trim(),
        name: document.getElementById('deviceName').value.trim() || 'Tombador',
        unidade_id: document.getElementById('deviceUnidade').value || null
      };

      if (!data.serial_number) {
        alert('Numero de serie e obrigatorio');
        return;
      }

      const result = await api('/api/devices', { method: 'POST', body: JSON.stringify(data) });

      if (result?.success) {
        closeDeviceModal();
        loadDevices();
        loadStats();
        alert('Dispositivo cadastrado com sucesso!\n\nQuando o dispositivo ficar online, ele sera reconhecido automaticamente.');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Excluir empresa
    async function deleteEmpresa(id, nome) {
      if (!confirm(`Tem certeza que deseja excluir a empresa "${nome}"?\n\nEsta acao nao pode ser desfeita!`)) return;

      const result = await api('/api/empresas/' + id, { method: 'DELETE' });

      if (result?.success) {
        loadEmpresas();
        loadStats();
        alert('Empresa excluida com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Excluir unidade
    async function deleteUnidade(id, nome, totalDevices) {
      if (totalDevices > 0) {
        alert(`Nao e possivel excluir. A unidade "${nome}" possui ${totalDevices} dispositivo(s) vinculado(s).\n\nDesvincule os dispositivos primeiro.`);
        return;
      }

      if (!confirm(`Tem certeza que deseja excluir a unidade "${nome}"?\n\nEsta acao nao pode ser desfeita!`)) return;

      const result = await api('/api/unidades/' + id, { method: 'DELETE' });

      if (result?.success) {
        loadUnidades();
        loadEmpresas();
        loadStats();
        alert('Unidade excluida com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Excluir dispositivo
    async function deleteDispositivo(serialNumber) {
      if (!confirm(`Tem certeza que deseja excluir o dispositivo "${serialNumber}"?\n\nTODOS OS DADOS DE TELEMETRIA SERAO PERDIDOS!\n\nEsta acao nao pode ser desfeita!`)) return;

      const result = await api('/api/devices/' + serialNumber, { method: 'DELETE' });

      if (result?.success) {
        loadDevices();
        loadStats();
        alert('Dispositivo e todos os dados excluidos com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Desvincular dispositivo
    async function desvincularDispositivo(serialNumber) {
      if (!confirm(`Desvincular o dispositivo "${serialNumber}" da unidade atual?`)) return;

      const result = await api('/api/devices/' + serialNumber + '/desvincular', { method: 'POST' });

      if (result?.success) {
        loadDevices();
        alert('Dispositivo desvinculado!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Modal Vincular Dispositivo
    function vincularDispositivo(serialNumber) {
      document.getElementById('vincularSerial').value = serialNumber;
      document.getElementById('vincularSerialDisplay').textContent = serialNumber;

      // Popular select de empresas
      const select = document.getElementById('vincularEmpresa');
      select.innerHTML = '<option value="">Selecione a empresa...</option>';
      empresasList.forEach(e => {
        select.innerHTML += `<option value="${e.id}">${e.razao_social} (${e.cnpj})</option>`;
      });

      document.getElementById('vincularUnidade').innerHTML = '<option value="">Selecione a empresa primeiro</option>';

      document.getElementById('vincularModal').classList.remove('hidden');
      document.getElementById('vincularModal').classList.add('flex');
    }

    function closeVincularModal() {
      document.getElementById('vincularModal').classList.add('hidden');
      document.getElementById('vincularModal').classList.remove('flex');
    }

    async function loadUnidadesVincular() {
      const empresaId = document.getElementById('vincularEmpresa').value;
      const select = document.getElementById('vincularUnidade');

      if (!empresaId) {
        select.innerHTML = '<option value="">Selecione a empresa primeiro</option>';
        return;
      }

      select.innerHTML = '<option value="">Carregando...</option>';

      const unidades = await api('/api/unidades?empresa_id=' + empresaId);
      if (unidades && unidades.length > 0) {
        select.innerHTML = '<option value="">Selecione a unidade...</option>';
        unidades.forEach(u => {
          select.innerHTML += `<option value="${u.id}">${u.nome} ${u.codigo ? '(' + u.codigo + ')' : ''}</option>`;
        });
      } else {
        select.innerHTML = '<option value="">Nenhuma unidade cadastrada para esta empresa</option>';
      }
    }

    async function confirmarVinculo() {
      const serialNumber = document.getElementById('vincularSerial').value;
      const unidadeId = document.getElementById('vincularUnidade').value;

      if (!unidadeId) {
        alert('Selecione uma unidade');
        return;
      }

      const result = await api('/api/devices/' + serialNumber + '/vincular', {
        method: 'POST',
        body: JSON.stringify({ unidade_id: parseInt(unidadeId) })
      });

      if (result?.success) {
        closeVincularModal();
        loadDevices();
        alert('Dispositivo vinculado com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Modal Editar Unidade
    async function editUnidade(id) {
      const unidade = await api('/api/unidades/' + id);
      if (!unidade || unidade.error) {
        alert('Erro ao carregar unidade: ' + (unidade?.error || 'Unidade nao encontrada'));
        return;
      }

      document.getElementById('editUnidadeId').value = unidade.id;
      document.getElementById('editUnidadeEmpresa').value = unidade.empresa_nome || '';
      document.getElementById('editUnidadeNome').value = unidade.nome || '';
      document.getElementById('editUnidadeCodigo').value = unidade.codigo || '';
      document.getElementById('editUnidadeResponsavel').value = unidade.responsavel || '';
      document.getElementById('editUnidadeCidade').value = unidade.cidade || '';
      document.getElementById('editUnidadeEstado').value = unidade.estado || '';

      document.getElementById('editUnidadeModal').classList.remove('hidden');
      document.getElementById('editUnidadeModal').classList.add('flex');
    }

    function closeEditUnidadeModal() {
      document.getElementById('editUnidadeModal').classList.add('hidden');
      document.getElementById('editUnidadeModal').classList.remove('flex');
    }

    async function saveEditUnidade() {
      const id = document.getElementById('editUnidadeId').value;
      const data = {
        nome: document.getElementById('editUnidadeNome').value,
        codigo: document.getElementById('editUnidadeCodigo').value,
        responsavel: document.getElementById('editUnidadeResponsavel').value,
        cidade: document.getElementById('editUnidadeCidade').value,
        estado: document.getElementById('editUnidadeEstado').value
      };

      if (!data.nome) {
        alert('Nome e obrigatorio');
        return;
      }

      const result = await api('/api/unidades/' + id, { method: 'PUT', body: JSON.stringify(data) });

      if (result?.success) {
        closeEditUnidadeModal();
        loadUnidades();
        alert('Unidade atualizada com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // ============ CUPONS DE DESCONTO ============

    // Load cupons
    async function loadCupons() {
      const cupons = await api('/api/cupons');
      if (!cupons) return;

      const tbody = document.getElementById('cuponsTableBody');

      if (cupons.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">Nenhum cupom cadastrado</td></tr>';
        return;
      }

      tbody.innerHTML = cupons.map(c => {
        const isExpired = c.valid_until && new Date(c.valid_until) < new Date();
        const isExhausted = c.max_uses > 0 && c.times_used >= c.max_uses;
        const isActive = c.active && !isExpired && !isExhausted;

        const statusClass = isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const statusText = !c.active ? 'Inativo' : isExpired ? 'Expirado' : isExhausted ? 'Esgotado' : 'Ativo';

        const tipoText = c.discount_type === 'percentual' ? `${c.discount_value}%` : `R$ ${parseFloat(c.discount_value).toFixed(2).replace('.', ',')}`;
        const validadeText = c.valid_until ? new Date(c.valid_until).toLocaleDateString('pt-BR') : 'Sem limite';
        const usoText = c.max_uses > 0 ? `${c.times_used}/${c.max_uses}` : `${c.times_used}/`;

        return `
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3 px-4">
              <span class="font-mono font-bold text-gray-800 bg-gray-100 px-2 py-1 rounded">${c.code}</span>
            </td>
            <td class="py-3 px-4 font-medium text-pili-red">${tipoText}</td>
            <td class="py-3 px-4 text-gray-600">${c.discount_type === 'percentual' ? 'Percentual' : 'Valor Fixo'}</td>
            <td class="py-3 px-4 text-gray-600">${validadeText}</td>
            <td class="py-3 px-4 text-gray-600">${usoText}</td>
            <td class="py-3 px-4">
              <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
            </td>
            <td class="py-3 px-4 text-right">
              <button onclick="toggleCupom(${c.id}, ${c.active})" class="p-2 hover:bg-gray-200 rounded-lg" title="${c.active ? 'Desativar' : 'Ativar'}">
                <svg class="w-4 h-4 ${c.active ? 'text-green-600' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </button>
              <button onclick="deleteCupom(${c.id}, '${c.code}')" class="p-2 hover:bg-red-100 rounded-lg" title="Excluir">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Modal functions - Cupom
    function openCupomModal() {
      document.getElementById('cupomForm').reset();
      document.getElementById('cupomId').value = '';
      document.getElementById('cupomModalTitle').textContent = 'Novo Cupom de Desconto';

      document.getElementById('cupomModal').classList.remove('hidden');
      document.getElementById('cupomModal').classList.add('flex');
    }

    function closeCupomModal() {
      document.getElementById('cupomModal').classList.add('hidden');
      document.getElementById('cupomModal').classList.remove('flex');
    }

    async function saveCupom() {
      const data = {
        code: document.getElementById('cupomCodigo').value.toUpperCase().trim(),
        discount_type: document.getElementById('cupomTipo').value,
        discount_value: parseFloat(document.getElementById('cupomValor').value),
        valid_until: document.getElementById('cupomValidade').value || null,
        max_uses: parseInt(document.getElementById('cupomLimiteUso').value) || 0,
        description: document.getElementById('cupomDescricao').value
      };

      if (!data.code || !data.discount_value) {
        alert('Codigo e valor do desconto sao obrigatorios');
        return;
      }

      if (data.discount_type === 'percentual' && (data.discount_value < 1 || data.discount_value > 100)) {
        alert('Percentual deve ser entre 1 e 100');
        return;
      }

      const result = await api('/api/cupons', { method: 'POST', body: JSON.stringify(data) });

      if (result?.success || result?.id) {
        closeCupomModal();
        loadCupons();
        alert('Cupom criado com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    async function toggleCupom(id, currentActive) {
      const action = currentActive ? 'desativar' : 'ativar';
      if (!confirm(`Deseja ${action} este cupom?`)) return;

      const result = await api('/api/cupons/' + id, {
        method: 'PUT',
        body: JSON.stringify({ active: !currentActive })
      });

      if (result?.success) {
        loadCupons();
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    async function deleteCupom(id, code) {
      if (!confirm(`Tem certeza que deseja excluir o cupom "${code}"?`)) return;

      const result = await api('/api/cupons/' + id, { method: 'DELETE' });

      if (result?.success) {
        loadCupons();
        alert('Cupom excluido com sucesso!');
      } else {
        alert('Erro: ' + (result?.error || 'Erro desconhecido'));
      }
    }

    // Refresh all data
    async function refreshData() {
      document.getElementById('lastUpdate').textContent = 'Atualizando...';
      await Promise.all([
        loadStats(),
        loadDevices()
      ]);
      document.getElementById('lastUpdate').textContent = 'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');
    }

    // Initial load
    async function init() {
      const authed = await checkAuth();
      if (authed) {
        await refreshData();
        setInterval(refreshData, 60000);
      }
    }

    init();
  </script>
</body>
</html>
