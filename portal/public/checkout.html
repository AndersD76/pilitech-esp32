<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Pagamento - PILI TECH Portal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 700;
      color: #dc2626;
      margin-bottom: 10px;
    }

    .header p {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    /* Trial Info */
    .trial-info {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      text-align: center;
    }

    .trial-info h2 {
      font-size: 1.5rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .trial-info p {
      font-size: 1rem;
      line-height: 1.6;
      opacity: 0.9;
    }

    .trial-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 1.2rem;
      font-weight: 700;
      margin: 15px 0;
    }

    /* Card Form */
    .card-form {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .card-form h3 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #94a3b8;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
    }

    .form-group input::placeholder {
      color: #64748b;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .card-icons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .card-icons span {
      background: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #1a1a2e;
      font-weight: 600;
    }

    /* Security Notice */
    .security-notice {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(74, 222, 128, 0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.85rem;
      color: #4ade80;
    }

    .security-notice svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Plan Summary */
    .plan-summary {
      background: rgba(220, 38, 38, 0.1);
      border: 2px solid #dc2626;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .plan-summary h4 {
      color: #dc2626;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }

    .plan-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .plan-item:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 1.1rem;
      padding-top: 12px;
    }

    .plan-item .free {
      color: #4ade80;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: #fff;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
    }

    .submit-btn:disabled {
      background: #64748b;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Terms */
    .terms {
      text-align: center;
      margin-top: 20px;
      font-size: 0.85rem;
      color: #64748b;
      line-height: 1.6;
    }

    .terms a {
      color: #dc2626;
      text-decoration: underline;
    }

    /* Messages */
    .message {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }

    .message.success {
      display: block;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid #4ade80;
      color: #4ade80;
    }

    .message.error {
      display: block;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    /* Success View */
    .success-view {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }

    .success-view.show {
      display: block;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
    }

    .success-view h2 {
      font-size: 1.8rem;
      margin-bottom: 16px;
      color: #4ade80;
    }

    .success-view p {
      color: #94a3b8;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .success-view .highlight {
      background: rgba(74, 222, 128, 0.1);
      padding: 16px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .success-view .highlight strong {
      color: #4ade80;
    }

    .btn-portal {
      display: inline-block;
      background: #dc2626;
      color: #fff;
      padding: 14px 32px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .btn-portal:hover {
      background: #b91c1c;
      transform: translateY(-2px);
    }

    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #dc2626;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Back Link */
    .back-link {
      text-align: center;
      margin-top: 30px;
    }

    .back-link a {
      color: #94a3b8;
      text-decoration: none;
    }

    .back-link a:hover {
      color: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">PILI TECH</div>
      <p>Sistema de Monitoramento IoT Industrial</p>
    </div>

    <!-- Form View -->
    <div id="formView">
      <!-- Trial Info -->
      <div class="trial-info">
        <h2>üéâ 30 Dias Gratis!</h2>
        <div class="trial-badge">TRIAL GRATUITO</div>
        <p>Cadastre seu cartao de credito para iniciar o periodo de avaliacao. <strong>Nao sera cobrado nada</strong> nos primeiros 30 dias. Voce pode cancelar a qualquer momento.</p>
      </div>

      <!-- Card Form -->
      <div class="card-form">
        <h3>üí≥ Dados do Cartao de Credito</h3>

        <div class="security-notice">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
          Seus dados sao criptografados e protegidos
        </div>

        <form id="cardForm" onsubmit="return false;">
          <div class="form-group">
            <label>Nome no Cartao *</label>
            <input type="text" id="cardName" placeholder="Como esta escrito no cartao" required autocomplete="cc-name">
          </div>

          <div class="form-group">
            <label>Numero do Cartao *</label>
            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" required maxlength="19" autocomplete="cc-number" oninput="formatCardNumber(this)">
            <div class="card-icons">
              <span>VISA</span>
              <span>MASTER</span>
              <span>ELO</span>
              <span>AMEX</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Validade *</label>
              <input type="text" id="cardExpiry" placeholder="MM/AA" required maxlength="5" autocomplete="cc-exp" oninput="formatExpiry(this)">
            </div>
            <div class="form-group">
              <label>CVV *</label>
              <input type="text" id="cardCvv" placeholder="123" required maxlength="4" autocomplete="cc-csc">
            </div>
          </div>

          <div class="form-group">
            <label>CPF do Titular *</label>
            <input type="text" id="cardCpf" placeholder="000.000.000-00" required maxlength="14" oninput="formatCpf(this)">
          </div>
        </form>
      </div>

      <!-- Cupom de Desconto -->
      <div class="card-form" style="padding: 20px; margin-bottom: 20px;">
        <h3 style="font-size: 1rem; margin-bottom: 15px;">üè∑Ô∏è Cupom de Desconto</h3>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="cupomCode" placeholder="Digite o codigo do cupom" style="flex: 1; text-transform: uppercase;">
          <button type="button" onclick="validarCupom()" id="btnValidarCupom" style="background: #dc2626; color: #fff; border: none; padding: 14px 20px; border-radius: 10px; font-weight: 600; cursor: pointer;">Aplicar</button>
        </div>
        <div id="cupomResult" style="margin-top: 10px; display: none;"></div>
      </div>

      <!-- Plan Summary -->
      <div class="plan-summary">
        <h4>Resumo do Plano Anual</h4>
        <div class="plan-item">
          <span>Primeiros 30 dias</span>
          <span class="free">GRATIS</span>
        </div>
        <div class="plan-item">
          <span>Valor do plano</span>
          <span id="precoOriginal">R$ 2.000,00/ano</span>
        </div>
        <div class="plan-item" id="descontoRow" style="display: none; color: #4ade80;">
          <span>Desconto (<span id="cupomAplicado">-</span>)</span>
          <span id="valorDesconto">-R$ 0,00</span>
        </div>
        <div class="plan-item" id="precoFinalRow" style="display: none;">
          <span>Valor final (apos trial)</span>
          <span id="precoFinal">R$ 2.000,00</span>
        </div>
        <div class="plan-item">
          <span>Cobranca hoje</span>
          <span class="free">R$ 0,00</span>
        </div>
      </div>

      <!-- Error Message -->
      <div id="errorMsg" class="message error"></div>

      <!-- Submit Button -->
      <button type="button" class="submit-btn" id="submitBtn" onclick="registerCard()">
        Cadastrar Cartao e Iniciar Trial
      </button>

      <div class="terms">
        Ao continuar, voce concorda com os <a href="#">Termos de Uso</a> e <a href="#">Politica de Privacidade</a>.<br>
        A cobranca de R$ 2.000,00 sera efetuada automaticamente apos 30 dias, caso nao cancele antes.
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Validando cartao...</p>
    </div>

    <!-- Success View -->
    <div class="success-view" id="successView">
      <div class="success-icon">‚úì</div>
      <h2>Cartao Cadastrado!</h2>
      <p>Seu periodo de avaliacao de 30 dias foi ativado com sucesso.</p>
      <div class="highlight">
        <p><strong>Nenhuma cobranca foi realizada.</strong></p>
        <p>Voce so sera cobrado apos o periodo de trial, caso nao cancele.</p>
      </div>
      <p style="font-size: 0.9rem;">Data de renovacao: <strong id="renewalDate">-</strong></p>
      <a href="/cliente.html" class="btn-portal">Acessar o Portal</a>
    </div>

    <div class="back-link">
      <a href="/cliente.html">‚Üê Voltar ao Portal</a>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('pilitech_token');
    let cupomAplicadoData = null;

    // Check auth
    if (!token) {
      window.location.href = '/';
    }

    // Verificar se ja esta no trial e ajustar mensagem
    (async function checkTrialStatus() {
      try {
        const res = await fetch('/api/subscription-status', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          const data = await res.json();
          const trialInfo = document.querySelector('.trial-info');
          if (trialInfo && data.status === 'trial') {
            const dias = data.trialDaysRemaining || data.daysRemaining || 0;
            trialInfo.innerHTML = `
              <h2>Assinar Plano Anual</h2>
              <div class="trial-badge" style="background:linear-gradient(135deg,#f59e0b,#d97706)">TRIAL ATIVO - ${dias} dias restantes</div>
              <p>Voce esta no periodo de avaliacao gratuita. Cadastre seu cartao para garantir a continuidade do servico apos o trial. <strong>Nao sera cobrado nada</strong> ate o fim do trial.</p>
            `;
          } else if (trialInfo && data.status === 'active') {
            trialInfo.innerHTML = `
              <h2>Assinatura Ativa</h2>
              <div class="trial-badge" style="background:linear-gradient(135deg,#22c55e,#16a34a)">PLANO ATIVO</div>
              <p>Sua assinatura esta ativa. Voce pode atualizar seus dados de pagamento abaixo.</p>
            `;
          }
        }
      } catch(e) { /* silencioso */ }
    })();

    // Validar cupom
    async function validarCupom() {
      const code = document.getElementById('cupomCode').value.trim();
      const resultDiv = document.getElementById('cupomResult');
      const btn = document.getElementById('btnValidarCupom');

      if (!code) {
        resultDiv.innerHTML = '<span style="color: #ef4444;">Digite um codigo de cupom</span>';
        resultDiv.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Validando...';

      try {
        const response = await fetch('/api/cupons/validate', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });

        const result = await response.json();

        if (!response.ok || result.error) {
          throw new Error(result.error || 'Cupom invalido');
        }

        // Cupom valido
        cupomAplicadoData = result;

        const descontoFormatado = result.cupom.discount_type === 'percentual'
          ? `${result.cupom.discount_value}%`
          : `R$ ${result.cupom.discount_value.toFixed(2).replace('.', ',')}`;

        resultDiv.innerHTML = `<span style="color: #4ade80;">‚úì Cupom aplicado! Desconto de ${descontoFormatado}</span>`;
        resultDiv.style.display = 'block';

        // Atualizar resumo
        document.getElementById('descontoRow').style.display = 'flex';
        document.getElementById('precoFinalRow').style.display = 'flex';
        document.getElementById('cupomAplicado').textContent = result.cupom.code;
        document.getElementById('valorDesconto').textContent = `-R$ ${result.desconto.toFixed(2).replace('.', ',')}`;
        document.getElementById('precoFinal').textContent = `R$ ${result.precoFinal.toFixed(2).replace('.', ',')}`;

        btn.textContent = 'Aplicado ‚úì';
        btn.style.background = '#059669';
        document.getElementById('cupomCode').disabled = true;

      } catch (err) {
        cupomAplicadoData = null;
        resultDiv.innerHTML = `<span style="color: #ef4444;">‚úó ${err.message}</span>`;
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Aplicar';
      }
    }

    // Format card number
    function formatCardNumber(input) {
      let value = input.value.replace(/\D/g, '');
      value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
      input.value = value.substring(0, 19);
    }

    // Format expiry
    function formatExpiry(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2);
      }
      input.value = value.substring(0, 5);
    }

    // Format CPF
    function formatCpf(input) {
      let value = input.value.replace(/\D/g, '');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      input.value = value.substring(0, 14);
    }

    // Validate card (basic Luhn check)
    function validateCard() {
      const name = document.getElementById('cardName').value.trim();
      const number = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expiry = document.getElementById('cardExpiry').value;
      const cvv = document.getElementById('cardCvv').value;
      const cpf = document.getElementById('cardCpf').value.replace(/\D/g, '');

      if (!name || name.length < 3) {
        throw new Error('Nome no cartao invalido');
      }

      if (number.length < 13 || number.length > 19) {
        throw new Error('Numero do cartao invalido');
      }

      const [month, year] = expiry.split('/');
      if (!month || !year || parseInt(month) < 1 || parseInt(month) > 12) {
        throw new Error('Data de validade invalida');
      }

      const currentYear = new Date().getFullYear() % 100;
      const currentMonth = new Date().getMonth() + 1;
      if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
        throw new Error('Cartao expirado');
      }

      if (cvv.length < 3) {
        throw new Error('CVV invalido');
      }

      if (cpf.length !== 11) {
        throw new Error('CPF invalido');
      }

      return {
        name,
        number,
        expiry,
        cvv,
        cpf
      };
    }

    // Register card
    async function registerCard() {
      const errorMsg = document.getElementById('errorMsg');
      const submitBtn = document.getElementById('submitBtn');

      try {
        errorMsg.style.display = 'none';
        const cardData = validateCard();

        submitBtn.disabled = true;
        submitBtn.textContent = 'Processando...';

        document.getElementById('formView').style.display = 'none';
        document.getElementById('loading').classList.add('show');

        // Send to backend
        const bodyData = {
          cardName: cardData.name,
          cardNumber: cardData.number,
          cardExpiry: cardData.expiry,
          cardCvv: cardData.cvv,
          cpf: cardData.cpf
        };

        // Adicionar cupom se houver
        if (cupomAplicadoData && cupomAplicadoData.cupom) {
          bodyData.cupom_code = cupomAplicadoData.cupom.code;
        }

        const response = await fetch('/api/payment/register-card', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bodyData)
        });

        const result = await response.json();

        document.getElementById('loading').classList.remove('show');

        if (!response.ok || result.error) {
          throw new Error(result.error || 'Erro ao cadastrar cartao');
        }

        // Success
        const renewalDate = new Date();
        renewalDate.setDate(renewalDate.getDate() + 30);
        document.getElementById('renewalDate').textContent = renewalDate.toLocaleDateString('pt-BR');

        document.getElementById('successView').classList.add('show');

        // Mark welcome as seen (so modal doesn't show again)
        localStorage.setItem('pilitech_welcome_seen', 'true');
        localStorage.setItem('pilitech_card_registered', 'true');

      } catch (err) {
        document.getElementById('loading').classList.remove('show');
        document.getElementById('formView').style.display = 'block';
        errorMsg.textContent = err.message;
        errorMsg.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cadastrar Cartao e Iniciar Trial';
      }
    }
  </script>
</body>
</html>
